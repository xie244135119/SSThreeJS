"use strict";var Vt=Object.defineProperty;var Ht=(y,e,i)=>e in y?Vt(y,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):y[e]=i;var ae=(y,e,i)=>(Ht(y,typeof e!="symbol"?e+"":e,i),i),ht=(y,e,i)=>{if(!e.has(y))throw TypeError("Cannot "+i)};var J=(y,e,i)=>(ht(y,e,"read from private field"),i?i.call(y):e.get(y)),Ne=(y,e,i)=>{if(e.has(y))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(y):e.set(y,i)},ke=(y,e,i,t)=>(ht(y,e,"write to private field"),t?t.call(y,i):e.set(y,i),i);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const s=require("three"),E=require("./three.path.module-5a19eed3.cjs"),Nt=require("lil-gui"),Ut=require("./tool/file.cjs");function Gt(y){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(y){for(const i in y)if(i!=="default"){const t=Object.getOwnPropertyDescriptor(y,i);Object.defineProperty(e,i,t.get?t:{enumerable:!0,get:()=>y[i]})}}return e.default=y,Object.freeze(e)}const L=Gt(s);class Wt{static isWebGLAvailable(){try{const e=document.createElement("canvas");return!!(window.WebGLRenderingContext&&(e.getContext("webgl")||e.getContext("experimental-webgl")))}catch{return!1}}static isWebGL2Available(){try{const e=document.createElement("canvas");return!!(window.WebGL2RenderingContext&&e.getContext("webgl2"))}catch{return!1}}static getWebGLErrorMessage(){return this.getErrorMessage(1)}static getWebGL2ErrorMessage(){return this.getErrorMessage(2)}static getErrorMessage(e){const i={1:"WebGL",2:"WebGL 2"},t={1:window.WebGLRenderingContext,2:window.WebGL2RenderingContext};let r='Your $0 does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">$1</a>';const n=document.createElement("div");return n.id="webglmessage",n.style.fontFamily="monospace",n.style.fontSize="13px",n.style.fontWeight="normal",n.style.textAlign="center",n.style.background="#fff",n.style.color="#000",n.style.padding="1.5em",n.style.width="400px",n.style.margin="5em auto 0",t[e]?r=r.replace("$0","graphics card"):r=r.replace("$0","browser"),r=r.replace("$1",i[e]),n.innerHTML=r,n}}const ct=Wt,dt={type:"change"},Je={type:"start"},ut={type:"end"};class it extends s.EventDispatcher{constructor(e,i){super(),this.object=e,this.domElement=i,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new s.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:s.MOUSE.ROTATE,MIDDLE:s.MOUSE.DOLLY,RIGHT:s.MOUSE.PAN},this.touches={ONE:s.TOUCH.ROTATE,TWO:s.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return a.phi},this.getAzimuthalAngle=function(){return a.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(l){l.addEventListener("keydown",Z),this._domElementKeyEvents=l},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",Z),this._domElementKeyEvents=null},this.saveState=function(){t.target0.copy(t.target),t.position0.copy(t.object.position),t.zoom0=t.object.zoom},this.reset=function(){t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.zoom=t.zoom0,t.object.updateProjectionMatrix(),t.dispatchEvent(dt),t.update(),n=r.NONE},this.update=function(){const l=new s.Vector3,O=new s.Quaternion().setFromUnitVectors(e.up,new s.Vector3(0,1,0)),$=O.clone().invert(),he=new s.Vector3,ce=new s.Quaternion,ye=2*Math.PI;return function(){const lt=t.object.position;l.copy(lt).sub(t.target),l.applyQuaternion(O),a.setFromVector3(l),t.autoRotate&&n===r.NONE&&R(Y()),t.enableDamping?(a.theta+=h.theta*t.dampingFactor,a.phi+=h.phi*t.dampingFactor):(a.theta+=h.theta,a.phi+=h.phi);let Te=t.minAzimuthAngle,Ee=t.maxAzimuthAngle;return isFinite(Te)&&isFinite(Ee)&&(Te<-Math.PI?Te+=ye:Te>Math.PI&&(Te-=ye),Ee<-Math.PI?Ee+=ye:Ee>Math.PI&&(Ee-=ye),Te<=Ee?a.theta=Math.max(Te,Math.min(Ee,a.theta)):a.theta=a.theta>(Te+Ee)/2?Math.max(Te,a.theta):Math.min(Ee,a.theta)),a.phi=Math.max(t.minPolarAngle,Math.min(t.maxPolarAngle,a.phi)),a.makeSafe(),a.radius*=d,a.radius=Math.max(t.minDistance,Math.min(t.maxDistance,a.radius)),t.enableDamping===!0?t.target.addScaledVector(u,t.dampingFactor):t.target.add(u),l.setFromSpherical(a),l.applyQuaternion($),lt.copy(t.target).add(l),t.object.lookAt(t.target),t.enableDamping===!0?(h.theta*=1-t.dampingFactor,h.phi*=1-t.dampingFactor,u.multiplyScalar(1-t.dampingFactor)):(h.set(0,0,0),u.set(0,0,0)),d=1,p||he.distanceToSquared(t.object.position)>o||8*(1-ce.dot(t.object.quaternion))>o?(t.dispatchEvent(dt),he.copy(t.object.position),ce.copy(t.object.quaternion),p=!1,!0):!1}}(),this.dispose=function(){t.domElement.removeEventListener("contextmenu",_),t.domElement.removeEventListener("pointerdown",T),t.domElement.removeEventListener("pointercancel",H),t.domElement.removeEventListener("wheel",I),t.domElement.removeEventListener("pointermove",D),t.domElement.removeEventListener("pointerup",H),t._domElementKeyEvents!==null&&(t._domElementKeyEvents.removeEventListener("keydown",Z),t._domElementKeyEvents=null)};const t=this,r={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let n=r.NONE;const o=1e-6,a=new s.Spherical,h=new s.Spherical;let d=1;const u=new s.Vector3;let p=!1;const k=new s.Vector2,f=new s.Vector2,v=new s.Vector2,m=new s.Vector2,c=new s.Vector2,M=new s.Vector2,P=new s.Vector2,g=new s.Vector2,x=new s.Vector2,S=[],A={};function Y(){return 2*Math.PI/60/60*t.autoRotateSpeed}function j(){return Math.pow(.95,t.zoomSpeed)}function R(l){h.theta-=l}function G(l){h.phi-=l}const V=function(){const l=new s.Vector3;return function($,he){l.setFromMatrixColumn(he,0),l.multiplyScalar(-$),u.add(l)}}(),oe=function(){const l=new s.Vector3;return function($,he){t.screenSpacePanning===!0?l.setFromMatrixColumn(he,1):(l.setFromMatrixColumn(he,0),l.crossVectors(t.object.up,l)),l.multiplyScalar($),u.add(l)}}(),fe=function(){const l=new s.Vector3;return function($,he){const ce=t.domElement;if(t.object.isPerspectiveCamera){const ye=t.object.position;l.copy(ye).sub(t.target);let Ye=l.length();Ye*=Math.tan(t.object.fov/2*Math.PI/180),V(2*$*Ye/ce.clientHeight,t.object.matrix),oe(2*he*Ye/ce.clientHeight,t.object.matrix)}else t.object.isOrthographicCamera?(V($*(t.object.right-t.object.left)/t.object.zoom/ce.clientWidth,t.object.matrix),oe(he*(t.object.top-t.object.bottom)/t.object.zoom/ce.clientHeight,t.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),t.enablePan=!1)}}();function ie(l){t.object.isPerspectiveCamera?d/=l:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom*l)),t.object.updateProjectionMatrix(),p=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function K(l){t.object.isPerspectiveCamera?d*=l:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/l)),t.object.updateProjectionMatrix(),p=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function pe(l){k.set(l.clientX,l.clientY)}function W(l){P.set(l.clientX,l.clientY)}function X(l){m.set(l.clientX,l.clientY)}function re(l){f.set(l.clientX,l.clientY),v.subVectors(f,k).multiplyScalar(t.rotateSpeed);const O=t.domElement;R(2*Math.PI*v.x/O.clientHeight),G(2*Math.PI*v.y/O.clientHeight),k.copy(f),t.update()}function se(l){g.set(l.clientX,l.clientY),x.subVectors(g,P),x.y>0?ie(j()):x.y<0&&K(j()),P.copy(g),t.update()}function be(l){c.set(l.clientX,l.clientY),M.subVectors(c,m).multiplyScalar(t.panSpeed),fe(M.x,M.y),m.copy(c),t.update()}function Se(l){l.deltaY<0?K(j()):l.deltaY>0&&ie(j()),t.update()}function Le(l){let O=!1;switch(l.code){case t.keys.UP:l.ctrlKey||l.metaKey||l.shiftKey?G(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):fe(0,t.keyPanSpeed),O=!0;break;case t.keys.BOTTOM:l.ctrlKey||l.metaKey||l.shiftKey?G(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):fe(0,-t.keyPanSpeed),O=!0;break;case t.keys.LEFT:l.ctrlKey||l.metaKey||l.shiftKey?R(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):fe(t.keyPanSpeed,0),O=!0;break;case t.keys.RIGHT:l.ctrlKey||l.metaKey||l.shiftKey?R(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):fe(-t.keyPanSpeed,0),O=!0;break}O&&(l.preventDefault(),t.update())}function Me(){if(S.length===1)k.set(S[0].pageX,S[0].pageY);else{const l=.5*(S[0].pageX+S[1].pageX),O=.5*(S[0].pageY+S[1].pageY);k.set(l,O)}}function ze(){if(S.length===1)m.set(S[0].pageX,S[0].pageY);else{const l=.5*(S[0].pageX+S[1].pageX),O=.5*(S[0].pageY+S[1].pageY);m.set(l,O)}}function _e(){const l=S[0].pageX-S[1].pageX,O=S[0].pageY-S[1].pageY,$=Math.sqrt(l*l+O*O);P.set(0,$)}function Ae(){t.enableZoom&&_e(),t.enablePan&&ze()}function b(){t.enableZoom&&_e(),t.enableRotate&&Me()}function U(l){if(S.length==1)f.set(l.pageX,l.pageY);else{const $=me(l),he=.5*(l.pageX+$.x),ce=.5*(l.pageY+$.y);f.set(he,ce)}v.subVectors(f,k).multiplyScalar(t.rotateSpeed);const O=t.domElement;R(2*Math.PI*v.x/O.clientHeight),G(2*Math.PI*v.y/O.clientHeight),k.copy(f)}function w(l){if(S.length===1)c.set(l.pageX,l.pageY);else{const O=me(l),$=.5*(l.pageX+O.x),he=.5*(l.pageY+O.y);c.set($,he)}M.subVectors(c,m).multiplyScalar(t.panSpeed),fe(M.x,M.y),m.copy(c)}function C(l){const O=me(l),$=l.pageX-O.x,he=l.pageY-O.y,ce=Math.sqrt($*$+he*he);g.set(0,ce),x.set(0,Math.pow(g.y/P.y,t.zoomSpeed)),ie(x.y),P.copy(g)}function F(l){t.enableZoom&&C(l),t.enablePan&&w(l)}function B(l){t.enableZoom&&C(l),t.enableRotate&&U(l)}function T(l){t.enabled!==!1&&(S.length===0&&(t.domElement.setPointerCapture(l.pointerId),t.domElement.addEventListener("pointermove",D),t.domElement.addEventListener("pointerup",H)),N(l),l.pointerType==="touch"?de(l):ee(l))}function D(l){t.enabled!==!1&&(l.pointerType==="touch"?z(l):le(l))}function H(l){Q(l),S.length===0&&(t.domElement.releasePointerCapture(l.pointerId),t.domElement.removeEventListener("pointermove",D),t.domElement.removeEventListener("pointerup",H)),t.dispatchEvent(ut),n=r.NONE}function ee(l){let O;switch(l.button){case 0:O=t.mouseButtons.LEFT;break;case 1:O=t.mouseButtons.MIDDLE;break;case 2:O=t.mouseButtons.RIGHT;break;default:O=-1}switch(O){case s.MOUSE.DOLLY:if(t.enableZoom===!1)return;W(l),n=r.DOLLY;break;case s.MOUSE.ROTATE:if(l.ctrlKey||l.metaKey||l.shiftKey){if(t.enablePan===!1)return;X(l),n=r.PAN}else{if(t.enableRotate===!1)return;pe(l),n=r.ROTATE}break;case s.MOUSE.PAN:if(l.ctrlKey||l.metaKey||l.shiftKey){if(t.enableRotate===!1)return;pe(l),n=r.ROTATE}else{if(t.enablePan===!1)return;X(l),n=r.PAN}break;default:n=r.NONE}n!==r.NONE&&t.dispatchEvent(Je)}function le(l){switch(n){case r.ROTATE:if(t.enableRotate===!1)return;re(l);break;case r.DOLLY:if(t.enableZoom===!1)return;se(l);break;case r.PAN:if(t.enablePan===!1)return;be(l);break}}function I(l){t.enabled===!1||t.enableZoom===!1||n!==r.NONE||(l.preventDefault(),t.dispatchEvent(Je),Se(l),t.dispatchEvent(ut))}function Z(l){t.enabled===!1||t.enablePan===!1||Le(l)}function de(l){switch(q(l),S.length){case 1:switch(t.touches.ONE){case s.TOUCH.ROTATE:if(t.enableRotate===!1)return;Me(),n=r.TOUCH_ROTATE;break;case s.TOUCH.PAN:if(t.enablePan===!1)return;ze(),n=r.TOUCH_PAN;break;default:n=r.NONE}break;case 2:switch(t.touches.TWO){case s.TOUCH.DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;Ae(),n=r.TOUCH_DOLLY_PAN;break;case s.TOUCH.DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;b(),n=r.TOUCH_DOLLY_ROTATE;break;default:n=r.NONE}break;default:n=r.NONE}n!==r.NONE&&t.dispatchEvent(Je)}function z(l){switch(q(l),n){case r.TOUCH_ROTATE:if(t.enableRotate===!1)return;U(l),t.update();break;case r.TOUCH_PAN:if(t.enablePan===!1)return;w(l),t.update();break;case r.TOUCH_DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;F(l),t.update();break;case r.TOUCH_DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;B(l),t.update();break;default:n=r.NONE}}function _(l){t.enabled!==!1&&l.preventDefault()}function N(l){S.push(l)}function Q(l){delete A[l.pointerId];for(let O=0;O<S.length;O++)if(S[O].pointerId==l.pointerId){S.splice(O,1);return}}function q(l){let O=A[l.pointerId];O===void 0&&(O=new s.Vector2,A[l.pointerId]=O),O.set(l.pageX,l.pageY)}function me(l){const O=l.pointerId===S[0].pointerId?S[1]:S[0];return A[O.pointerId]}t.domElement.addEventListener("contextmenu",_),t.domElement.addEventListener("pointerdown",T),t.domElement.addEventListener("pointercancel",H),t.domElement.addEventListener("wheel",I,{passive:!1}),this.update()}}class Dt extends s.DataTextureLoader{constructor(e){super(e),this.type=s.HalfFloatType}parse(e){const a=function(g,x){switch(g){case 1:console.error("THREE.RGBELoader Read Error: "+(x||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(x||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(x||""));break;default:case 4:console.error("THREE.RGBELoader: Error: "+(x||""))}return-1},p=`
`,k=function(g,x,S){x=x||1024;let Y=g.pos,j=-1,R=0,G="",V=String.fromCharCode.apply(null,new Uint16Array(g.subarray(Y,Y+128)));for(;0>(j=V.indexOf(p))&&R<x&&Y<g.byteLength;)G+=V,R+=V.length,Y+=128,V+=String.fromCharCode.apply(null,new Uint16Array(g.subarray(Y,Y+128)));return-1<j?(S!==!1&&(g.pos+=R+j+1),G+V.slice(0,j)):!1},f=function(g){const x=/^#\?(\S+)/,S=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,A=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,Y=/^\s*FORMAT=(\S+)\s*$/,j=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,R={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let G,V;if(g.pos>=g.byteLength||!(G=k(g)))return a(1,"no header found");if(!(V=G.match(x)))return a(3,"bad initial token");for(R.valid|=1,R.programtype=V[1],R.string+=G+`
`;G=k(g),G!==!1;){if(R.string+=G+`
`,G.charAt(0)==="#"){R.comments+=G+`
`;continue}if((V=G.match(S))&&(R.gamma=parseFloat(V[1])),(V=G.match(A))&&(R.exposure=parseFloat(V[1])),(V=G.match(Y))&&(R.valid|=2,R.format=V[1]),(V=G.match(j))&&(R.valid|=4,R.height=parseInt(V[1],10),R.width=parseInt(V[2],10)),R.valid&2&&R.valid&4)break}return R.valid&2?R.valid&4?R:a(3,"missing image size specifier"):a(3,"missing format specifier")},v=function(g,x,S){const A=x;if(A<8||A>32767||g[0]!==2||g[1]!==2||g[2]&128)return new Uint8Array(g);if(A!==(g[2]<<8|g[3]))return a(3,"wrong scanline width");const Y=new Uint8Array(4*x*S);if(!Y.length)return a(4,"unable to allocate buffer space");let j=0,R=0;const G=4*A,V=new Uint8Array(4),oe=new Uint8Array(G);let fe=S;for(;fe>0&&R<g.byteLength;){if(R+4>g.byteLength)return a(1);if(V[0]=g[R++],V[1]=g[R++],V[2]=g[R++],V[3]=g[R++],V[0]!=2||V[1]!=2||(V[2]<<8|V[3])!=A)return a(3,"bad rgbe scanline format");let ie=0,K;for(;ie<G&&R<g.byteLength;){K=g[R++];const W=K>128;if(W&&(K-=128),K===0||ie+K>G)return a(3,"bad scanline data");if(W){const X=g[R++];for(let re=0;re<K;re++)oe[ie++]=X}else oe.set(g.subarray(R,R+K),ie),ie+=K,R+=K}const pe=A;for(let W=0;W<pe;W++){let X=0;Y[j]=oe[W+X],X+=A,Y[j+1]=oe[W+X],X+=A,Y[j+2]=oe[W+X],X+=A,Y[j+3]=oe[W+X],j+=4}fe--}return Y},m=function(g,x,S,A){const Y=g[x+3],j=Math.pow(2,Y-128)/255;S[A+0]=g[x+0]*j,S[A+1]=g[x+1]*j,S[A+2]=g[x+2]*j,S[A+3]=1},c=function(g,x,S,A){const Y=g[x+3],j=Math.pow(2,Y-128)/255;S[A+0]=s.DataUtils.toHalfFloat(Math.min(g[x+0]*j,65504)),S[A+1]=s.DataUtils.toHalfFloat(Math.min(g[x+1]*j,65504)),S[A+2]=s.DataUtils.toHalfFloat(Math.min(g[x+2]*j,65504)),S[A+3]=s.DataUtils.toHalfFloat(1)},M=new Uint8Array(e);M.pos=0;const P=f(M);if(P!==-1){const g=P.width,x=P.height,S=v(M.subarray(M.pos),g,x);if(S!==-1){let A,Y,j;switch(this.type){case s.FloatType:j=S.length/4;const R=new Float32Array(j*4);for(let V=0;V<j;V++)m(S,V*4,R,V*4);A=R,Y=s.FloatType;break;case s.HalfFloatType:j=S.length/4;const G=new Uint16Array(j*4);for(let V=0;V<j;V++)c(S,V*4,G,V*4);A=G,Y=s.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type);break}return{width:g,height:x,data:A,header:P.string,gamma:P.gamma,exposure:P.exposure,type:Y}}}return null}setDataType(e){return this.type=e,this}load(e,i,t,r){function n(o,a){switch(o.type){case s.FloatType:case s.HalfFloatType:o.colorSpace=s.LinearSRGBColorSpace,o.minFilter=s.LinearFilter,o.magFilter=s.LinearFilter,o.generateMipmaps=!1,o.flipY=!0;break}i&&i(o,a)}return super.load(e,n,t,r)}}class Qt extends s.Loader{constructor(e){super(e),this.hdrLoader=new Dt,this.type=s.HalfFloatType}load(e,i,t,r){const n=new s.CubeTexture;switch(n.type=this.type,n.type){case s.FloatType:n.colorSpace=s.LinearSRGBColorSpace,n.minFilter=s.LinearFilter,n.magFilter=s.LinearFilter,n.generateMipmaps=!1;break;case s.HalfFloatType:n.colorSpace=s.LinearSRGBColorSpace,n.minFilter=s.LinearFilter,n.magFilter=s.LinearFilter,n.generateMipmaps=!1;break}const o=this;let a=0;function h(d,u,p,k){new s.FileLoader(o.manager).setPath(o.path).setResponseType("arraybuffer").setWithCredentials(o.withCredentials).load(e[d],function(f){a++;const v=o.hdrLoader.parse(f);if(v){if(v.data!==void 0){const m=new s.DataTexture(v.data,v.width,v.height);m.type=n.type,m.colorSpace=n.colorSpace,m.format=n.format,m.minFilter=n.minFilter,m.magFilter=n.magFilter,m.generateMipmaps=n.generateMipmaps,n.images[d]=m}a===6&&(n.needsUpdate=!0,u&&u(n))}},p,k)}for(let d=0;d<e.length;d++)h(d,i,t,r);return n}setDataType(e){return this.type=e,this.hdrLoader.setDataType(e),this}}class $e extends s.Mesh{constructor(){const e=$e.SkyShader,i=new s.ShaderMaterial({name:"SkyShader",fragmentShader:e.fragmentShader,vertexShader:e.vertexShader,uniforms:s.UniformsUtils.clone(e.uniforms),side:s.BackSide,depthWrite:!1});super(new s.BoxGeometry(1,1,1),i),this.isSky=!0}}$e.SkyShader={uniforms:{turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new s.Vector3},up:{value:new s.Vector3(0,1,0)}},vertexShader:`
		uniform vec3 sunPosition;
		uniform float rayleigh;
		uniform float turbidity;
		uniform float mieCoefficient;
		uniform vec3 up;

		varying vec3 vWorldPosition;
		varying vec3 vSunDirection;
		varying float vSunfade;
		varying vec3 vBetaR;
		varying vec3 vBetaM;
		varying float vSunE;

		// constants for atmospheric scattering
		const float e = 2.71828182845904523536028747135266249775724709369995957;
		const float pi = 3.141592653589793238462643383279502884197169;

		// wavelength of used primaries, according to preetham
		const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );
		// this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:
		// (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))
		const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );

		// mie stuff
		// K coefficient for the primaries
		const float v = 4.0;
		const vec3 K = vec3( 0.686, 0.678, 0.666 );
		// MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K
		const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );

		// earth shadow hack
		// cutoffAngle = pi / 1.95;
		const float cutoffAngle = 1.6110731556870734;
		const float steepness = 1.5;
		const float EE = 1000.0;

		float sunIntensity( float zenithAngleCos ) {
			zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );
			return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );
		}

		vec3 totalMie( float T ) {
			float c = ( 0.2 * T ) * 10E-18;
			return 0.434 * c * MieConst;
		}

		void main() {

			vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
			vWorldPosition = worldPosition.xyz;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			gl_Position.z = gl_Position.w; // set z to camera.far

			vSunDirection = normalize( sunPosition );

			vSunE = sunIntensity( dot( vSunDirection, up ) );

			vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );

			float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );

			// extinction (absorbtion + out scattering)
			// rayleigh coefficients
			vBetaR = totalRayleigh * rayleighCoefficient;

			// mie coefficients
			vBetaM = totalMie( turbidity ) * mieCoefficient;

		}`,fragmentShader:`
		varying vec3 vWorldPosition;
		varying vec3 vSunDirection;
		varying float vSunfade;
		varying vec3 vBetaR;
		varying vec3 vBetaM;
		varying float vSunE;

		uniform float mieDirectionalG;
		uniform vec3 up;

		const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );

		// constants for atmospheric scattering
		const float pi = 3.141592653589793238462643383279502884197169;

		const float n = 1.0003; // refractive index of air
		const float N = 2.545E25; // number of molecules per unit volume for air at 288.15K and 1013mb (sea level -45 celsius)

		// optical length at zenith for molecules
		const float rayleighZenithLength = 8.4E3;
		const float mieZenithLength = 1.25E3;
		// 66 arc seconds -> degrees, and the cosine of that
		const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;

		// 3.0 / ( 16.0 * pi )
		const float THREE_OVER_SIXTEENPI = 0.05968310365946075;
		// 1.0 / ( 4.0 * pi )
		const float ONE_OVER_FOURPI = 0.07957747154594767;

		float rayleighPhase( float cosTheta ) {
			return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );
		}

		float hgPhase( float cosTheta, float g ) {
			float g2 = pow( g, 2.0 );
			float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );
			return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );
		}

		void main() {

			vec3 direction = normalize( vWorldPosition - cameraPos );

			// optical length
			// cutoff angle at 90 to avoid singularity in next formula.
			float zenithAngle = acos( max( 0.0, dot( up, direction ) ) );
			float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );
			float sR = rayleighZenithLength * inverse;
			float sM = mieZenithLength * inverse;

			// combined extinction factor
			vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );

			// in scattering
			float cosTheta = dot( direction, vSunDirection );

			float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );
			vec3 betaRTheta = vBetaR * rPhase;

			float mPhase = hgPhase( cosTheta, mieDirectionalG );
			vec3 betaMTheta = vBetaM * mPhase;

			vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );
			Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );

			// nightsky
			float theta = acos( direction.y ); // elevation --> y-axis, [-pi/2, pi/2]
			float phi = atan( direction.z, direction.x ); // azimuth --> x-axis [-pi/2, pi/2]
			vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );
			vec3 L0 = vec3( 0.1 ) * Fex;

			// composition + solar disc
			float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );
			L0 += ( vSunE * 19000.0 * Fex ) * sundisk;

			vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );

			vec3 retColor = pow( texColor, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );

			gl_FragColor = vec4( retColor, 1.0 );

			#include <tonemapping_fragment>
			#include <encodings_fragment>

		}`};class Lt{constructor(e){this.threeContainer=null,this.threeScene=null,this.sceneHelper=null,this.threeCamera=null,this.threeRenderer=null,this.threeOrbitControl=null,this.threeEffectComposer=null,this._resizeObserver=null,this.getModelsByPoint=(i,t=this.threeScene.children,r=[])=>{const n=new L.Vector2(i.offsetX/this.threeContainer.offsetWidth*2-1,-(i.offsetY/this.threeContainer.offsetHeight)*2+1),o=["AmbientLight","PointLight","PointLightHelper","SpotLight","SpotLightHelper","DirectionalLight","DirectionalLightHelper","TransformControls","CameraHelper","AxesHelper","GridHelper","BoxHelper"],h=(t||this.threeScene.children).filter(v=>o.indexOf(v.constructor.name)===-1),d=new L.Raycaster;d.setFromCamera(n,this.threeCamera);let u=d.intersectObjects(h,!0);const p=["Line","Line2","Line3"],k=["可视域视锥体"],f=v=>!(k.indexOf(v.name)!==-1||r.indexOf(v.name)!==-1);return u=u.filter(v=>p.indexOf(v.object.type)===-1&&v.object.visible===!0&&f(v.object)),u},this.changeCameraMode=i=>{var t;if(i!==this.threeCamera.type){if(this.removeCameraHelper(),this.threeCamera&&(this.threeCamera=null,(t=this.threeOrbitControl)==null||t.dispose(),this.threeOrbitControl=null),i==="PerspectiveCamera"){const r=new L.PerspectiveCamera;r.position.set(2,2,2),this.threeCamera=r,this.threeOrbitControl=new it(this.threeCamera,this.threeContainer)}else if(i==="OrthographicCamera"){const r=new L.OrthographicCamera;r.position.set(0,4,0),this.threeCamera=r,this.threeOrbitControl=new it(this.threeCamera,this.threeContainer)}this.renderOnce(),this.threeOrbitControl.update(),this.addCameraHelper()}},this.autoWindowResize=()=>{this.threeRenderer.setSize(this.threeContainer.offsetWidth,this.threeContainer.offsetHeight);const i=new window.ResizeObserver(()=>{this.updateCameraMatrix(),this.threeRenderer.setSize(this.threeContainer.offsetWidth,this.threeContainer.offsetHeight)});i.observe(this.threeContainer),this._resizeObserver=i},this.threeContainer=e.container,this.threeScene=e.scene,this.sceneHelper=e.sceneHelper,this.threeOrbitControl=e.control,this.threeCamera=e.camera,this.threeRenderer=e.renderer,this.threeEffectComposer=e.effectComposer}destory(){var e;(e=this._resizeObserver)==null||e.disconnect(),this._resizeObserver=null,this.cancelRenderLoop(),this.removeCameraHelper()}setEye(e,i,t=!0,r=.5,n){if(!t)this.threeCamera.position.copy(e),this.threeOrbitControl.target.copy(i),this.threeOrbitControl.update();else{const o={camera_x:this.threeCamera.position.x,camera_y:this.threeCamera.position.y,camera_z:this.threeCamera.position.z,orbitControl_x:this.threeOrbitControl.target.x,orbitControl_y:this.threeOrbitControl.target.y,orbitControl_z:this.threeOrbitControl.target.z},a={camera_x:e.x,camera_y:e.y,camera_z:e.z,orbitControl_x:i.x,orbitControl_y:i.y,orbitControl_z:i.z};E.SSThreeTool.useTweenAnimate(o,a,h=>{this.threeCamera.position.set(h.camera_x,h.camera_y,h.camera_z),this.threeOrbitControl.target.set(h.orbitControl_x,h.orbitControl_y,h.orbitControl_z),this.threeOrbitControl.update()},r,n)}}getEye(){return{camera:this.threeCamera.position,target:this.threeOrbitControl.target}}updateCameraMatrix(){const e=this.threeContainer.offsetWidth/this.threeContainer.offsetHeight;this.threeCamera instanceof L.PerspectiveCamera?this.threeCamera.aspect=e:this.threeCamera instanceof L.OrthographicCamera&&(this.threeCamera.left=-e*1,this.threeCamera.right=e*1,this.threeCamera.top=1,this.threeCamera.bottom=-1),this.threeCamera.updateProjectionMatrix()}renderLoop(){this.updateCameraMatrix(),E.SSThreeLoop.add(()=>{this.threeRenderer.render(this.threeScene,this.threeCamera)},"webglrender update")}renderOnce(){this.threeRenderer.render(this.threeScene,this.threeCamera),this.sceneHelper&&(this.threeRenderer.autoClear=!1,this.threeRenderer.render(this.sceneHelper,this.threeCamera),this.threeRenderer.autoClear=!0)}cancelRenderLoop(){E.SSThreeLoop.removeId("webglrender update")}addCameraHelper(){const e=new L.CameraHelper(this.threeCamera);e.name="Camera Helper",this.threeScene.add(e)}removeCameraHelper(){const e=this.threeScene.getObjectByName("Camera Helper");e instanceof L.CameraHelper&&(e.dispose(),this.threeScene.remove(e))}}class Yt{constructor(){this._subscribeObjs={},this.subscribe=(e,i)=>{const t=this._subscribeObjs[e]||[],r=Symbol("subcribe");return t.push({type:r,fn:i}),this._subscribeObjs[e]=t,r},this.remove=(e,i)=>{const t=this._subscribeObjs[e]||[],r=t.findIndex(n=>n.type===i);t.splice(r,1)},this.publish=(e="",i={})=>{const t=this._subscribeObjs[e]||[];for(let r=0;r<t.length;r+=1){const{fn:n}=t[r];n==null||n(i)}}}}const ft=new Yt,pt="SSModuleUpdateScribe";class At{constructor(e){ae(this,"_debugGui",null);ae(this,"_ssThreeObject",null);ae(this,"_menuContainer",null);ae(this,"_modules",null);ae(this,"_currentEnableModule",null);ae(this,"getModuleByClassName",e=>{var i;return(i=this._modules)==null?void 0:i.find(t=>t.__name===e)});ae(this,"_addModuleGui",e=>{var t,r;const i=(t=e.getModuleConfig)==null?void 0:t.call(e);if(i){i.模块调试=!1;const n=this._debugGui.addFolder(e.title||e.__name);e.__gui=n;const o=(r=e.getModuleConfigSource)==null?void 0:r.call(e);return this._addDebugForObject(i,n,a=>{var h;a.key==="模块调试"&&(a.value?(this._currentEnableModule&&this._currentEnableModule.moduleUpdateGuiValue("模块调试",!1),e.moduleOpenDebug(),this._currentEnableModule=e):(e.moduleCloseDebug(),this._currentEnableModule=null)),i.模块调试&&((h=e.moduleGuiChange)==null||h.call(e,{...a,target:i}))},o),n}return null});ae(this,"_addDrawIcon",()=>{const e=document.createElement("div");e.innerText="调",e.className=E.styles.menuicon,this._ssThreeObject.threeContainer.parentElement.append(e),["relative","absolute"].indexOf(this._ssThreeObject.threeContainer.parentElement.style.position)===-1&&(this._ssThreeObject.threeContainer.parentElement.style.position="relative"),e.onclick=()=>{this._menuContainer.parentElement.style.right="0px",this._menuContainer.parentElement.style.opacity=1}});ae(this,"_addDrawerView",()=>{const e=document.createElement("div");e.className=E.styles.drawer,this._ssThreeObject.threeContainer.parentElement.append(e);const i=document.createElement("div");i.className=E.styles.drawerheader,e.append(i);const t=document.createElement("span");t.className=E.styles.drawerheadertitle,t.innerText="场景调试",i.append(t);const r=document.createElement("div");r.innerText="X",r.className=E.styles.drawerheaderclose,i.append(r),r.onpointerdown=()=>{e.style.right=`-${e.offsetWidth}px`};const n=document.createElement("div");n.className=E.styles.contentview,e.append(n),this._menuContainer=n;const o=document.createElement("div");o.className=E.styles.drawerfooter,e.append(o);const a=document.createElement("div");a.className=E.styles.drawerfooterbtn,a.innerText="导出配置",o.append(a),a.onclick=()=>{this.export()}});this._ssThreeObject=e}destroy(){var e;this.unregisterModules(),this.closeDebugModel(),(e=this._debugGui)==null||e.destroy()}registerModules(e=[]){this._modules=[],e.forEach(i=>{var r;const t=new i;t.ssThreeObject=this._ssThreeObject,t.__name=i.name,(r=t.moduleMount)==null||r.call(t,this._ssThreeObject),this._modules.push(t)}),ft.subscribe(pt,i=>{const t=i.__gui;t==null||t.destroy(),this._debugGui&&this._addModuleGui(i).open()})}unregisterModules(){var e;(e=this._modules)==null||e.forEach(i=>{var t;i.ssThreeObject=null,(t=i.moduleUnmount)==null||t.call(i)}),this._modules=null}export(){const e={};this._modules.forEach(i=>{var r;const t=(r=i.moduleExport)==null?void 0:r.call(i);t&&(e[i.__name]=t)}),Ut.exportJson(e,"ssthreejs.setting.json")}import(e={}){this._modules.forEach(i=>{const t=e[i.__name];if(t){const r=n=>{Object.keys(n).forEach(o=>{const a=n[o];a instanceof Object&&(a.r!==void 0&&a.g!==void 0&&a.b!==void 0&&(n[o]=new L.Color(a.r,a.g,a.b)),r(a))})};r(t),i.moduleImport(t),ft.publish(pt,i)}})}openDebugModel(){this._addDrawIcon(),this._addDrawerView(),this._debugGui===null&&(this._debugGui=new Nt({autoPlace:!0,injectStyles:!0,title:"场景调试",closeFolders:!0,container:this._menuContainer,width:"100%"})),this._modules.forEach(this._addModuleGui)}closeDebugModel(){var e;this._menuContainer&&((e=this._menuContainer.parentElement)==null||e.remove())}_addDebugForObject(e={},i=this._debugGui,t=null,r={}){var o,a;const n=Object.keys(e);for(let h=0;h<n.length;h++){const d=n[h],u=e[d];if(u instanceof L.Color){i.addColor({[d]:u.getRGB({})},d).onChange(f=>{e[d]=f,t==null||t({key:d,value:f,data:e})});continue}if(u instanceof Array&&u.length>0){const f=i.addFolder(d);u.forEach((v,m)=>{if(v instanceof Object){const c=f.addFolder(m+1);this._addDebugForObject(v,c,t,r)}});continue}if(u instanceof Object&&!(u instanceof Function)){const f=i.addFolder(d);this._addDebugForObject(u,f,t,r);continue}const p=r[d];if(p instanceof Array){(o=i.add(e,d,p))==null||o.onChange(f=>{e[d]=f,t==null||t({key:d,value:f,data:e})});continue}const k=r[d]||{};(a=i.add(e,d,k.min,k.max,k.step))==null||a.onChange(f=>{e[d]=f,t==null||t({key:d,value:f,data:e})})}}}class Bt{constructor(e=0){this._queueList=[],this._runing=!1,this._delayTime=0,this._delayTime=e}add(e=()=>{}){e&&this._queueList.push(e),this._excute()}remove(){setTimeout(()=>{this._runing=!1,this._queueList.splice(0,1),this._excute()},this._delayTime)}_excute(){if(!this._runing&&this._queueList.length>0){const e=this._queueList[0];e&&(this._runing=!0,e())}}destory(){this._queueList=[]}}const Be=new s.Raycaster,ge=new s.Vector3,Re=new s.Vector3,ne=new s.Quaternion,mt={X:new s.Vector3(1,0,0),Y:new s.Vector3(0,1,0),Z:new s.Vector3(0,0,1)},et={type:"change"},gt={type:"mouseDown"},yt={type:"mouseUp",mode:null},vt={type:"objectChange"};class Xt extends s.Object3D{constructor(e,i){super(),i===void 0&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),i=document),this.isTransformControls=!0,this.visible=!1,this.domElement=i,this.domElement.style.touchAction="none";const t=new ei;this._gizmo=t,this.add(t);const r=new ti;this._plane=r,this.add(r);const n=this;function o(P,g){let x=g;Object.defineProperty(n,P,{get:function(){return x!==void 0?x:g},set:function(S){x!==S&&(x=S,r[P]=S,t[P]=S,n.dispatchEvent({type:P+"-changed",value:S}),n.dispatchEvent(et))}}),n[P]=g,r[P]=g,t[P]=g}o("camera",e),o("object",void 0),o("enabled",!0),o("axis",null),o("mode","translate"),o("translationSnap",null),o("rotationSnap",null),o("scaleSnap",null),o("space","world"),o("size",1),o("dragging",!1),o("showX",!0),o("showY",!0),o("showZ",!0);const a=new s.Vector3,h=new s.Vector3,d=new s.Quaternion,u=new s.Quaternion,p=new s.Vector3,k=new s.Quaternion,f=new s.Vector3,v=new s.Vector3,m=new s.Vector3,c=0,M=new s.Vector3;o("worldPosition",a),o("worldPositionStart",h),o("worldQuaternion",d),o("worldQuaternionStart",u),o("cameraPosition",p),o("cameraQuaternion",k),o("pointStart",f),o("pointEnd",v),o("rotationAxis",m),o("rotationAngle",c),o("eye",M),this._offset=new s.Vector3,this._startNorm=new s.Vector3,this._endNorm=new s.Vector3,this._cameraScale=new s.Vector3,this._parentPosition=new s.Vector3,this._parentQuaternion=new s.Quaternion,this._parentQuaternionInv=new s.Quaternion,this._parentScale=new s.Vector3,this._worldScaleStart=new s.Vector3,this._worldQuaternionInv=new s.Quaternion,this._worldScale=new s.Vector3,this._positionStart=new s.Vector3,this._quaternionStart=new s.Quaternion,this._scaleStart=new s.Vector3,this._getPointer=Zt.bind(this),this._onPointerDown=Kt.bind(this),this._onPointerHover=qt.bind(this),this._onPointerMove=$t.bind(this),this._onPointerUp=Jt.bind(this),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp)}updateMatrixWorld(){this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this._parentPosition,this._parentQuaternion,this._parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this._worldScale),this._parentQuaternionInv.copy(this._parentQuaternion).invert(),this._worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this._cameraScale),this.camera.isOrthographicCamera?this.camera.getWorldDirection(this.eye).negate():this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld(this)}pointerHover(e){if(this.object===void 0||this.dragging===!0)return;Be.setFromCamera(e,this.camera);const i=tt(this._gizmo.picker[this.mode],Be);i?this.axis=i.object.name:this.axis=null}pointerDown(e){if(!(this.object===void 0||this.dragging===!0||e.button!==0)&&this.axis!==null){Be.setFromCamera(e,this.camera);const i=tt(this._plane,Be,!0);i&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(i.point).sub(this.worldPositionStart)),this.dragging=!0,gt.mode=this.mode,this.dispatchEvent(gt)}}pointerMove(e){const i=this.axis,t=this.mode,r=this.object;let n=this.space;if(t==="scale"?n="local":(i==="E"||i==="XYZE"||i==="XYZ")&&(n="world"),r===void 0||i===null||this.dragging===!1||e.button!==-1)return;Be.setFromCamera(e,this.camera);const o=tt(this._plane,Be,!0);if(o){if(this.pointEnd.copy(o.point).sub(this.worldPositionStart),t==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),n==="local"&&i!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),i.indexOf("X")===-1&&(this._offset.x=0),i.indexOf("Y")===-1&&(this._offset.y=0),i.indexOf("Z")===-1&&(this._offset.z=0),n==="local"&&i!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),r.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(n==="local"&&(r.position.applyQuaternion(ne.copy(this._quaternionStart).invert()),i.search("X")!==-1&&(r.position.x=Math.round(r.position.x/this.translationSnap)*this.translationSnap),i.search("Y")!==-1&&(r.position.y=Math.round(r.position.y/this.translationSnap)*this.translationSnap),i.search("Z")!==-1&&(r.position.z=Math.round(r.position.z/this.translationSnap)*this.translationSnap),r.position.applyQuaternion(this._quaternionStart)),n==="world"&&(r.parent&&r.position.add(ge.setFromMatrixPosition(r.parent.matrixWorld)),i.search("X")!==-1&&(r.position.x=Math.round(r.position.x/this.translationSnap)*this.translationSnap),i.search("Y")!==-1&&(r.position.y=Math.round(r.position.y/this.translationSnap)*this.translationSnap),i.search("Z")!==-1&&(r.position.z=Math.round(r.position.z/this.translationSnap)*this.translationSnap),r.parent&&r.position.sub(ge.setFromMatrixPosition(r.parent.matrixWorld))));else if(t==="scale"){if(i.search("XYZ")!==-1){let a=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(a*=-1),Re.set(a,a,a)}else ge.copy(this.pointStart),Re.copy(this.pointEnd),ge.applyQuaternion(this._worldQuaternionInv),Re.applyQuaternion(this._worldQuaternionInv),Re.divide(ge),i.search("X")===-1&&(Re.x=1),i.search("Y")===-1&&(Re.y=1),i.search("Z")===-1&&(Re.z=1);r.scale.copy(this._scaleStart).multiply(Re),this.scaleSnap&&(i.search("X")!==-1&&(r.scale.x=Math.round(r.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),i.search("Y")!==-1&&(r.scale.y=Math.round(r.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),i.search("Z")!==-1&&(r.scale.z=Math.round(r.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(t==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const a=20/this.worldPosition.distanceTo(ge.setFromMatrixPosition(this.camera.matrixWorld));i==="E"?(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1):i==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(ge.copy(this.rotationAxis).cross(this.eye))*a):(i==="X"||i==="Y"||i==="Z")&&(this.rotationAxis.copy(mt[i]),ge.copy(mt[i]),n==="local"&&ge.applyQuaternion(this.worldQuaternion),this.rotationAngle=this._offset.dot(ge.cross(this.eye).normalize())*a),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),n==="local"&&i!=="E"&&i!=="XYZE"?(r.quaternion.copy(this._quaternionStart),r.quaternion.multiply(ne.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),r.quaternion.copy(ne.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),r.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(et),this.dispatchEvent(vt)}}pointerUp(e){e.button===0&&(this.dragging&&this.axis!==null&&(yt.mode=this.mode,this.dispatchEvent(yt)),this.dragging=!1,this.axis=null)}dispose(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})}attach(e){return this.object=e,this.visible=!0,this}detach(){return this.object=void 0,this.visible=!1,this.axis=null,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(et),this.dispatchEvent(vt),this.pointStart.copy(this.pointEnd))}getRaycaster(){return Be}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}}function Zt(y){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:y.button};{const e=this.domElement.getBoundingClientRect();return{x:(y.clientX-e.left)/e.width*2-1,y:-(y.clientY-e.top)/e.height*2+1,button:y.button}}}function qt(y){if(this.enabled)switch(y.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(y));break}}function Kt(y){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(y.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(y)),this.pointerDown(this._getPointer(y)))}function $t(y){this.enabled&&this.pointerMove(this._getPointer(y))}function Jt(y){this.enabled&&(this.domElement.releasePointerCapture(y.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(y)))}function tt(y,e,i){const t=e.intersectObject(y,!0);for(let r=0;r<t.length;r++)if(t[r].object.visible||i)return t[r];return!1}const Xe=new s.Euler,te=new s.Vector3(0,1,0),bt=new s.Vector3(0,0,0),St=new s.Matrix4,Ze=new s.Quaternion,Ke=new s.Quaternion,xe=new s.Vector3,xt=new s.Matrix4,We=new s.Vector3(1,0,0),Ie=new s.Vector3(0,1,0),Qe=new s.Vector3(0,0,1),qe=new s.Vector3,Ue=new s.Vector3,Ge=new s.Vector3;class ei extends s.Object3D{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const e=new s.MeshBasicMaterial({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),i=new s.LineBasicMaterial({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=e.clone();t.opacity=.15;const r=i.clone();r.opacity=.5;const n=e.clone();n.color.setHex(16711680);const o=e.clone();o.color.setHex(65280);const a=e.clone();a.color.setHex(255);const h=e.clone();h.color.setHex(16711680),h.opacity=.5;const d=e.clone();d.color.setHex(65280),d.opacity=.5;const u=e.clone();u.color.setHex(255),u.opacity=.5;const p=e.clone();p.opacity=.25;const k=e.clone();k.color.setHex(16776960),k.opacity=.25,e.clone().color.setHex(16776960);const v=e.clone();v.color.setHex(7895160);const m=new s.CylinderGeometry(0,.04,.1,12);m.translate(0,.05,0);const c=new s.BoxGeometry(.08,.08,.08);c.translate(0,.04,0);const M=new s.BufferGeometry;M.setAttribute("position",new s.Float32BufferAttribute([0,0,0,1,0,0],3));const P=new s.CylinderGeometry(.0075,.0075,.5,3);P.translate(0,.25,0);function g(K,pe){const W=new s.TorusGeometry(K,.0075,3,64,pe*Math.PI*2);return W.rotateY(Math.PI/2),W.rotateX(Math.PI/2),W}function x(){const K=new s.BufferGeometry;return K.setAttribute("position",new s.Float32BufferAttribute([0,0,0,1,1,1],3)),K}const S={X:[[new s.Mesh(m,n),[.5,0,0],[0,0,-Math.PI/2]],[new s.Mesh(m,n),[-.5,0,0],[0,0,Math.PI/2]],[new s.Mesh(P,n),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new s.Mesh(m,o),[0,.5,0]],[new s.Mesh(m,o),[0,-.5,0],[Math.PI,0,0]],[new s.Mesh(P,o)]],Z:[[new s.Mesh(m,a),[0,0,.5],[Math.PI/2,0,0]],[new s.Mesh(m,a),[0,0,-.5],[-Math.PI/2,0,0]],[new s.Mesh(P,a),null,[Math.PI/2,0,0]]],XYZ:[[new s.Mesh(new s.OctahedronGeometry(.1,0),p.clone()),[0,0,0]]],XY:[[new s.Mesh(new s.BoxGeometry(.15,.15,.01),u.clone()),[.15,.15,0]]],YZ:[[new s.Mesh(new s.BoxGeometry(.15,.15,.01),h.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new s.Mesh(new s.BoxGeometry(.15,.15,.01),d.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},A={X:[[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[.3,0,0],[0,0,-Math.PI/2]],[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[0,.3,0]],[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[0,-.3,0],[0,0,Math.PI]]],Z:[[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[0,0,.3],[Math.PI/2,0,0]],[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new s.Mesh(new s.OctahedronGeometry(.2,0),t)]],XY:[[new s.Mesh(new s.BoxGeometry(.2,.2,.01),t),[.15,.15,0]]],YZ:[[new s.Mesh(new s.BoxGeometry(.2,.2,.01),t),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new s.Mesh(new s.BoxGeometry(.2,.2,.01),t),[.15,0,.15],[-Math.PI/2,0,0]]]},Y={START:[[new s.Mesh(new s.OctahedronGeometry(.01,2),r),null,null,null,"helper"]],END:[[new s.Mesh(new s.OctahedronGeometry(.01,2),r),null,null,null,"helper"]],DELTA:[[new s.Line(x(),r),null,null,null,"helper"]],X:[[new s.Line(M,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new s.Line(M,r.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new s.Line(M,r.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},j={XYZE:[[new s.Mesh(g(.5,1),v),null,[0,Math.PI/2,0]]],X:[[new s.Mesh(g(.5,.5),n)]],Y:[[new s.Mesh(g(.5,.5),o),null,[0,0,-Math.PI/2]]],Z:[[new s.Mesh(g(.5,.5),a),null,[0,Math.PI/2,0]]],E:[[new s.Mesh(g(.75,1),k),null,[0,Math.PI/2,0]]]},R={AXIS:[[new s.Line(M,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},G={XYZE:[[new s.Mesh(new s.SphereGeometry(.25,10,8),t)]],X:[[new s.Mesh(new s.TorusGeometry(.5,.1,4,24),t),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new s.Mesh(new s.TorusGeometry(.5,.1,4,24),t),[0,0,0],[Math.PI/2,0,0]]],Z:[[new s.Mesh(new s.TorusGeometry(.5,.1,4,24),t),[0,0,0],[0,0,-Math.PI/2]]],E:[[new s.Mesh(new s.TorusGeometry(.75,.1,2,24),t)]]},V={X:[[new s.Mesh(c,n),[.5,0,0],[0,0,-Math.PI/2]],[new s.Mesh(P,n),[0,0,0],[0,0,-Math.PI/2]],[new s.Mesh(c,n),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new s.Mesh(c,o),[0,.5,0]],[new s.Mesh(P,o)],[new s.Mesh(c,o),[0,-.5,0],[0,0,Math.PI]]],Z:[[new s.Mesh(c,a),[0,0,.5],[Math.PI/2,0,0]],[new s.Mesh(P,a),[0,0,0],[Math.PI/2,0,0]],[new s.Mesh(c,a),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new s.Mesh(new s.BoxGeometry(.15,.15,.01),u),[.15,.15,0]]],YZ:[[new s.Mesh(new s.BoxGeometry(.15,.15,.01),h),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new s.Mesh(new s.BoxGeometry(.15,.15,.01),d),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new s.Mesh(new s.BoxGeometry(.1,.1,.1),p.clone())]]},oe={X:[[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[.3,0,0],[0,0,-Math.PI/2]],[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[0,.3,0]],[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[0,-.3,0],[0,0,Math.PI]]],Z:[[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[0,0,.3],[Math.PI/2,0,0]],[new s.Mesh(new s.CylinderGeometry(.2,0,.6,4),t),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new s.Mesh(new s.BoxGeometry(.2,.2,.01),t),[.15,.15,0]]],YZ:[[new s.Mesh(new s.BoxGeometry(.2,.2,.01),t),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new s.Mesh(new s.BoxGeometry(.2,.2,.01),t),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new s.Mesh(new s.BoxGeometry(.2,.2,.2),t),[0,0,0]]]},fe={X:[[new s.Line(M,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new s.Line(M,r.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new s.Line(M,r.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function ie(K){const pe=new s.Object3D;for(const W in K)for(let X=K[W].length;X--;){const re=K[W][X][0].clone(),se=K[W][X][1],be=K[W][X][2],Se=K[W][X][3],Le=K[W][X][4];re.name=W,re.tag=Le,se&&re.position.set(se[0],se[1],se[2]),be&&re.rotation.set(be[0],be[1],be[2]),Se&&re.scale.set(Se[0],Se[1],Se[2]),re.updateMatrix();const Me=re.geometry.clone();Me.applyMatrix4(re.matrix),re.geometry=Me,re.renderOrder=1/0,re.position.set(0,0,0),re.rotation.set(0,0,0),re.scale.set(1,1,1),pe.add(re)}return pe}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=ie(S)),this.add(this.gizmo.rotate=ie(j)),this.add(this.gizmo.scale=ie(V)),this.add(this.picker.translate=ie(A)),this.add(this.picker.rotate=ie(G)),this.add(this.picker.scale=ie(oe)),this.add(this.helper.translate=ie(Y)),this.add(this.helper.rotate=ie(R)),this.add(this.helper.scale=ie(fe)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(e){const t=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:Ke;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let r=[];r=r.concat(this.picker[this.mode].children),r=r.concat(this.gizmo[this.mode].children),r=r.concat(this.helper[this.mode].children);for(let n=0;n<r.length;n++){const o=r[n];o.visible=!0,o.rotation.set(0,0,0),o.position.copy(this.worldPosition);let a;if(this.camera.isOrthographicCamera?a=(this.camera.top-this.camera.bottom)/this.camera.zoom:a=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),o.scale.set(1,1,1).multiplyScalar(a*this.size/4),o.tag==="helper"){o.visible=!1,o.name==="AXIS"?(o.visible=!!this.axis,this.axis==="X"&&(ne.setFromEuler(Xe.set(0,0,0)),o.quaternion.copy(t).multiply(ne),Math.abs(te.copy(We).applyQuaternion(t).dot(this.eye))>.9&&(o.visible=!1)),this.axis==="Y"&&(ne.setFromEuler(Xe.set(0,0,Math.PI/2)),o.quaternion.copy(t).multiply(ne),Math.abs(te.copy(Ie).applyQuaternion(t).dot(this.eye))>.9&&(o.visible=!1)),this.axis==="Z"&&(ne.setFromEuler(Xe.set(0,Math.PI/2,0)),o.quaternion.copy(t).multiply(ne),Math.abs(te.copy(Qe).applyQuaternion(t).dot(this.eye))>.9&&(o.visible=!1)),this.axis==="XYZE"&&(ne.setFromEuler(Xe.set(0,Math.PI/2,0)),te.copy(this.rotationAxis),o.quaternion.setFromRotationMatrix(St.lookAt(bt,te,Ie)),o.quaternion.multiply(ne),o.visible=this.dragging),this.axis==="E"&&(o.visible=!1)):o.name==="START"?(o.position.copy(this.worldPositionStart),o.visible=this.dragging):o.name==="END"?(o.position.copy(this.worldPosition),o.visible=this.dragging):o.name==="DELTA"?(o.position.copy(this.worldPositionStart),o.quaternion.copy(this.worldQuaternionStart),ge.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),ge.applyQuaternion(this.worldQuaternionStart.clone().invert()),o.scale.copy(ge),o.visible=this.dragging):(o.quaternion.copy(t),this.dragging?o.position.copy(this.worldPositionStart):o.position.copy(this.worldPosition),this.axis&&(o.visible=this.axis.search(o.name)!==-1));continue}o.quaternion.copy(t),this.mode==="translate"||this.mode==="scale"?(o.name==="X"&&Math.abs(te.copy(We).applyQuaternion(t).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="Y"&&Math.abs(te.copy(Ie).applyQuaternion(t).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="Z"&&Math.abs(te.copy(Qe).applyQuaternion(t).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="XY"&&Math.abs(te.copy(Qe).applyQuaternion(t).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="YZ"&&Math.abs(te.copy(We).applyQuaternion(t).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="XZ"&&Math.abs(te.copy(Ie).applyQuaternion(t).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1)):this.mode==="rotate"&&(Ze.copy(t),te.copy(this.eye).applyQuaternion(ne.copy(t).invert()),o.name.search("E")!==-1&&o.quaternion.setFromRotationMatrix(St.lookAt(this.eye,bt,Ie)),o.name==="X"&&(ne.setFromAxisAngle(We,Math.atan2(-te.y,te.z)),ne.multiplyQuaternions(Ze,ne),o.quaternion.copy(ne)),o.name==="Y"&&(ne.setFromAxisAngle(Ie,Math.atan2(te.x,te.z)),ne.multiplyQuaternions(Ze,ne),o.quaternion.copy(ne)),o.name==="Z"&&(ne.setFromAxisAngle(Qe,Math.atan2(te.y,te.x)),ne.multiplyQuaternions(Ze,ne),o.quaternion.copy(ne))),o.visible=o.visible&&(o.name.indexOf("X")===-1||this.showX),o.visible=o.visible&&(o.name.indexOf("Y")===-1||this.showY),o.visible=o.visible&&(o.name.indexOf("Z")===-1||this.showZ),o.visible=o.visible&&(o.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),o.material._color=o.material._color||o.material.color.clone(),o.material._opacity=o.material._opacity||o.material.opacity,o.material.color.copy(o.material._color),o.material.opacity=o.material._opacity,this.enabled&&this.axis&&(o.name===this.axis||this.axis.split("").some(function(h){return o.name===h}))&&(o.material.color.setHex(16776960),o.material.opacity=1)}super.updateMatrixWorld(e)}}class ti extends s.Mesh{constructor(){super(new s.PlaneGeometry(1e5,1e5,2,2),new s.MeshBasicMaterial({visible:!1,wireframe:!0,side:s.DoubleSide,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(e){let i=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(i="local"),qe.copy(We).applyQuaternion(i==="local"?this.worldQuaternion:Ke),Ue.copy(Ie).applyQuaternion(i==="local"?this.worldQuaternion:Ke),Ge.copy(Qe).applyQuaternion(i==="local"?this.worldQuaternion:Ke),te.copy(Ue),this.mode){case"translate":case"scale":switch(this.axis){case"X":te.copy(this.eye).cross(qe),xe.copy(qe).cross(te);break;case"Y":te.copy(this.eye).cross(Ue),xe.copy(Ue).cross(te);break;case"Z":te.copy(this.eye).cross(Ge),xe.copy(Ge).cross(te);break;case"XY":xe.copy(Ge);break;case"YZ":xe.copy(qe);break;case"XZ":te.copy(Ge),xe.copy(Ue);break;case"XYZ":case"E":xe.set(0,0,0);break}break;case"rotate":default:xe.set(0,0,0)}xe.length()===0?this.quaternion.copy(this.cameraQuaternion):(xt.lookAt(ge.set(0,0,0),xe,te),this.quaternion.setFromRotationMatrix(xt)),super.updateMatrixWorld(e)}}class ii{constructor(e,i){this.onControlChange=null,this._ssThreeObject=null,this._control=null,this._event=null,this._boxHeloper=null,this.focus=t=>{const r=this._ssThreeObject.threeCamera;let n;const o=new L.Box3,a=new L.Vector3,h=new L.Sphere,d=new L.Vector3;o.setFromObject(t),o.isEmpty()===!1?(o.getCenter(a),n=o.getBoundingSphere(h).radius):(a.setFromMatrixPosition(t.matrixWorld),n=.1),d.set(0,0,1),d.applyQuaternion(r.quaternion),d.multiplyScalar(n*2),r.position.copy(a).add(d),this._ssThreeObject.threeOrbitControl.target.copy(a),this._ssThreeObject.threeOrbitControl.update()},this._ssThreeObject=e,this.onControlChange=i}destory(){var e,i,t;(e=this._event)==null||e.destory(),this._event=null,this._ssThreeObject=null,(i=this._control)==null||i.removeFromParent(),(t=this._control)==null||t.dispose(),this.onControlChange=null,this._control=null}attach(e){this._control||(this._control=new Xt(this._ssThreeObject.threeCamera,this._ssThreeObject.threeContainer),(this._ssThreeObject.sceneHelper||this._ssThreeObject.threeScene).add(this._control),this._control.addEventListener("change",i=>{var t,r;this._ssThreeObject.threeOrbitControl.enableRotate=!this._control.dragging,this._control.object&&((t=this._boxHeloper)==null||t.setFromObject(this._control.object),(r=this.onControlChange)==null||r.call(this,{name:this._control.object.name,uuid:this._control.object.uuid,target:this._control.object,type:"change",position:new L.Vector3(this._control.object.position.x,this._control.object.position.y,this._control.object.position.z),rotation:new L.Vector3(L.MathUtils.radToDeg(this._control.object.rotation.x),L.MathUtils.radToDeg(this._control.object.rotation.y),L.MathUtils.radToDeg(this._control.object.rotation.z)),scale:this._control.object.scale}))}),this._control.addEventListener("objectChange",i=>{}),this._event=new E.SSEvent(this._ssThreeObject.threeContainer),this._event.addEventListener(E.SSEvent.SSEventType.KEYDOWN,i=>{var t,r;if(this._control.object)switch(i.key){case"q":this._control.setSpace(this._control.space==="world"?"local":"world");break;case"e":this._control.setMode("rotate");break;case"w":this._control.setMode("translate");break;case"r":this._control.setMode("scale");break;case"x":this._control.showX=!this._control.showX;break;case"y":this._control.showY=!this._control.showY;break;case"z":this._control.showZ=!this._control.showZ;break;case"Escape":this.detach();break;case"_":case"-":this._control.setSize(this._control.size*.9);break;case"f":if(!this._control.object)return;this.focus(this._control.object),(t=this.onControlChange)==null||t.call(this,{name:this._control.object.name,uuid:this._control.object.uuid,target:this._control.object,type:"focus"});break;case"=":case"+":this._control.setSize(this._control.size*1.1);break;case"Backspace":if(!this._control.object)return;this._boxHeloper.removeFromParent(),this._boxHeloper=null;const{name:n,uuid:o,id:a}=this._control.object;this._control.detach(),(r=this.onControlChange)==null||r.call(this,{name:n,uuid:o,targetId:a,type:"delete"});break}})),this._control.attach(e),this._boxHeloper||(this._boxHeloper=new L.BoxHelper(e),this._boxHeloper.name="boxhelper",(this._ssThreeObject.sceneHelper||this._ssThreeObject.threeScene).add(this._boxHeloper)),this._boxHeloper.setFromObject(e)}detach(){var e;this._control.detach(),(e=this._boxHeloper)==null||e.removeFromParent(),this._boxHeloper=null}set enabled(e){this._control&&(e||this.detach(),this._control.enabled=e)}}const ot={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform float opacity;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			gl_FragColor = texture2D( tDiffuse, vUv );
			gl_FragColor.a *= opacity;


		}`};class He{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const ri=new s.OrthographicCamera(-1,1,1,-1,0,1),nt=new s.BufferGeometry;nt.setAttribute("position",new s.Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3));nt.setAttribute("uv",new s.Float32BufferAttribute([0,2,0,0,2,0],2));class at{constructor(e){this._mesh=new s.Mesh(nt,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,ri)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class rt extends He{constructor(e,i){super(),this.textureID=i!==void 0?i:"tDiffuse",e instanceof s.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=s.UniformsUtils.clone(e.uniforms),this.material=new s.ShaderMaterial({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new at(this.material)}render(e,i,t){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=t.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(i),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class wt extends He{constructor(e,i){super(),this.scene=e,this.camera=i,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,i,t){const r=e.getContext(),n=e.state;n.buffers.color.setMask(!1),n.buffers.depth.setMask(!1),n.buffers.color.setLocked(!0),n.buffers.depth.setLocked(!0);let o,a;this.inverse?(o=0,a=1):(o=1,a=0),n.buffers.stencil.setTest(!0),n.buffers.stencil.setOp(r.REPLACE,r.REPLACE,r.REPLACE),n.buffers.stencil.setFunc(r.ALWAYS,o,4294967295),n.buffers.stencil.setClear(a),n.buffers.stencil.setLocked(!0),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(i),this.clear&&e.clear(),e.render(this.scene,this.camera),n.buffers.color.setLocked(!1),n.buffers.depth.setLocked(!1),n.buffers.stencil.setLocked(!1),n.buffers.stencil.setFunc(r.EQUAL,1,4294967295),n.buffers.stencil.setOp(r.KEEP,r.KEEP,r.KEEP),n.buffers.stencil.setLocked(!0)}}class si extends He{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class Mt{constructor(e,i){if(this.renderer=e,this._pixelRatio=e.getPixelRatio(),i===void 0){const t=e.getSize(new s.Vector2);this._width=t.width,this._height=t.height,i=new s.WebGLRenderTarget(this._width*this._pixelRatio,this._height*this._pixelRatio),i.texture.name="EffectComposer.rt1"}else this._width=i.width,this._height=i.height;this.renderTarget1=i,this.renderTarget2=i.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new rt(ot),this.clock=new s.Clock}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,i){this.passes.splice(i,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const i=this.passes.indexOf(e);i!==-1&&this.passes.splice(i,1)}isLastEnabledPass(e){for(let i=e+1;i<this.passes.length;i++)if(this.passes[i].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const i=this.renderer.getRenderTarget();let t=!1;for(let r=0,n=this.passes.length;r<n;r++){const o=this.passes[r];if(o.enabled!==!1){if(o.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(r),o.render(this.renderer,this.writeBuffer,this.readBuffer,e,t),o.needsSwap){if(t){const a=this.renderer.getContext(),h=this.renderer.state.buffers.stencil;h.setFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),h.setFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}wt!==void 0&&(o instanceof wt?t=!0:o instanceof si&&(t=!1))}}this.renderer.setRenderTarget(i)}reset(e){if(e===void 0){const i=this.renderer.getSize(new s.Vector2);this._pixelRatio=this.renderer.getPixelRatio(),this._width=i.width,this._height=i.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,i){this._width=e,this._height=i;const t=this._width*this._pixelRatio,r=this._height*this._pixelRatio;this.renderTarget1.setSize(t,r),this.renderTarget2.setSize(t,r);for(let n=0;n<this.passes.length;n++)this.passes[n].setSize(t,r)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class oi extends He{constructor(e,i,t,r,n){super(),this.scene=e,this.camera=i,this.overrideMaterial=t,this.clearColor=r,this.clearAlpha=n!==void 0?n:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new s.Color}render(e,i,t){const r=e.autoClear;e.autoClear=!1;let n,o;this.overrideMaterial!==void 0&&(o=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),n=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,n),this.overrideMaterial!==void 0&&(this.scene.overrideMaterial=o),e.autoClear=r}}const ni={shaderID:"luminosityHighPass",uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new s.Color(0)},defaultOpacity:{value:0}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform vec3 defaultColor;
		uniform float defaultOpacity;
		uniform float luminosityThreshold;
		uniform float smoothWidth;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );

			vec3 luma = vec3( 0.299, 0.587, 0.114 );

			float v = dot( texel.xyz, luma );

			vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );

			float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );

			gl_FragColor = mix( outputColor, texel, alpha );

		}`};class Ve extends He{constructor(e,i,t,r){super(),this.strength=i!==void 0?i:1,this.radius=t,this.threshold=r,this.resolution=e!==void 0?new s.Vector2(e.x,e.y):new s.Vector2(256,256),this.clearColor=new s.Color(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let n=Math.round(this.resolution.x/2),o=Math.round(this.resolution.y/2);this.renderTargetBright=new s.WebGLRenderTarget(n,o),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let p=0;p<this.nMips;p++){const k=new s.WebGLRenderTarget(n,o);k.texture.name="UnrealBloomPass.h"+p,k.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(k);const f=new s.WebGLRenderTarget(n,o);f.texture.name="UnrealBloomPass.v"+p,f.texture.generateMipmaps=!1,this.renderTargetsVertical.push(f),n=Math.round(n/2),o=Math.round(o/2)}const a=ni;this.highPassUniforms=s.UniformsUtils.clone(a.uniforms),this.highPassUniforms.luminosityThreshold.value=r,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new s.ShaderMaterial({uniforms:this.highPassUniforms,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,defines:{}}),this.separableBlurMaterials=[];const h=[3,5,7,9,11];n=Math.round(this.resolution.x/2),o=Math.round(this.resolution.y/2);for(let p=0;p<this.nMips;p++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(h[p])),this.separableBlurMaterials[p].uniforms.texSize.value=new s.Vector2(n,o),n=Math.round(n/2),o=Math.round(o/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=i,this.compositeMaterial.uniforms.bloomRadius.value=.1,this.compositeMaterial.needsUpdate=!0;const d=[1,.8,.6,.4,.2];this.compositeMaterial.uniforms.bloomFactors.value=d,this.bloomTintColors=[new s.Vector3(1,1,1),new s.Vector3(1,1,1),new s.Vector3(1,1,1),new s.Vector3(1,1,1),new s.Vector3(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors;const u=ot;this.copyUniforms=s.UniformsUtils.clone(u.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new s.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:u.vertexShader,fragmentShader:u.fragmentShader,blending:s.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new s.Color,this.oldClearAlpha=1,this.basic=new s.MeshBasicMaterial,this.fsQuad=new at(null)}dispose(){for(let e=0;e<this.renderTargetsHorizontal.length;e++)this.renderTargetsHorizontal[e].dispose();for(let e=0;e<this.renderTargetsVertical.length;e++)this.renderTargetsVertical[e].dispose();this.renderTargetBright.dispose();for(let e=0;e<this.separableBlurMaterials.length;e++)this.separableBlurMaterials[e].dispose();this.compositeMaterial.dispose(),this.materialCopy.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(e,i){let t=Math.round(e/2),r=Math.round(i/2);this.renderTargetBright.setSize(t,r);for(let n=0;n<this.nMips;n++)this.renderTargetsHorizontal[n].setSize(t,r),this.renderTargetsVertical[n].setSize(t,r),this.separableBlurMaterials[n].uniforms.texSize.value=new s.Vector2(t,r),t=Math.round(t/2),r=Math.round(r/2)}render(e,i,t,r,n){e.getClearColor(this._oldClearColor),this.oldClearAlpha=e.getClearAlpha();const o=e.autoClear;e.autoClear=!1,e.setClearColor(this.clearColor,0),n&&e.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=t.texture,e.setRenderTarget(null),e.clear(),this.fsQuad.render(e)),this.highPassUniforms.tDiffuse.value=t.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,e.setRenderTarget(this.renderTargetBright),e.clear(),this.fsQuad.render(e);let a=this.renderTargetBright;for(let h=0;h<this.nMips;h++)this.fsQuad.material=this.separableBlurMaterials[h],this.separableBlurMaterials[h].uniforms.colorTexture.value=a.texture,this.separableBlurMaterials[h].uniforms.direction.value=Ve.BlurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[h]),e.clear(),this.fsQuad.render(e),this.separableBlurMaterials[h].uniforms.colorTexture.value=this.renderTargetsHorizontal[h].texture,this.separableBlurMaterials[h].uniforms.direction.value=Ve.BlurDirectionY,e.setRenderTarget(this.renderTargetsVertical[h]),e.clear(),this.fsQuad.render(e),a=this.renderTargetsVertical[h];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,e.setRenderTarget(this.renderTargetsHorizontal[0]),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,n&&e.state.buffers.stencil.setTest(!0),this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.fsQuad.render(e)),e.setClearColor(this._oldClearColor,this.oldClearAlpha),e.autoClear=o}getSeperableBlurMaterial(e){return new s.ShaderMaterial({defines:{KERNEL_RADIUS:e,SIGMA:e},uniforms:{colorTexture:{value:null},texSize:{value:new s.Vector2(.5,.5)},direction:{value:new s.Vector2(.5,.5)}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`#include <common>
				varying vec2 vUv;
				uniform sampler2D colorTexture;
				uniform vec2 texSize;
				uniform vec2 direction;

				float gaussianPdf(in float x, in float sigma) {
					return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;
				}
				void main() {
					vec2 invSize = 1.0 / texSize;
					float fSigma = float(SIGMA);
					float weightSum = gaussianPdf(0.0, fSigma);
					vec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;
					for( int i = 1; i < KERNEL_RADIUS; i ++ ) {
						float x = float(i);
						float w = gaussianPdf(x, fSigma);
						vec2 uvOffset = direction * invSize * x;
						vec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;
						vec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;
						diffuseSum += (sample1 + sample2) * w;
						weightSum += 2.0 * w;
					}
					gl_FragColor = vec4(diffuseSum/weightSum, 1.0);
				}`})}getCompositeMaterial(e){return new s.ShaderMaterial({defines:{NUM_MIPS:e},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;
				uniform sampler2D blurTexture1;
				uniform sampler2D blurTexture2;
				uniform sampler2D blurTexture3;
				uniform sampler2D blurTexture4;
				uniform sampler2D blurTexture5;
				uniform float bloomStrength;
				uniform float bloomRadius;
				uniform float bloomFactors[NUM_MIPS];
				uniform vec3 bloomTintColors[NUM_MIPS];

				float lerpBloomFactor(const in float factor) {
					float mirrorFactor = 1.2 - factor;
					return mix(factor, mirrorFactor, bloomRadius);
				}

				void main() {
					gl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +
						lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +
						lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +
						lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +
						lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );
				}`})}}Ve.BlurDirectionX=new s.Vector2(1,0);Ve.BlurDirectionY=new s.Vector2(0,1);class De extends He{constructor(e,i,t,r){super(),this.renderScene=i,this.renderCamera=t,this.selectedObjects=r!==void 0?r:[],this.visibleEdgeColor=new s.Color(1,1,1),this.hiddenEdgeColor=new s.Color(.1,.04,.02),this.edgeGlow=0,this.usePatternTexture=!1,this.edgeThickness=1,this.edgeStrength=3,this.downSampleRatio=2,this.pulsePeriod=0,this._visibilityCache=new Map,this.resolution=e!==void 0?new s.Vector2(e.x,e.y):new s.Vector2(256,256);const n=Math.round(this.resolution.x/this.downSampleRatio),o=Math.round(this.resolution.y/this.downSampleRatio);this.renderTargetMaskBuffer=new s.WebGLRenderTarget(this.resolution.x,this.resolution.y),this.renderTargetMaskBuffer.texture.name="OutlinePass.mask",this.renderTargetMaskBuffer.texture.generateMipmaps=!1,this.depthMaterial=new s.MeshDepthMaterial,this.depthMaterial.side=s.DoubleSide,this.depthMaterial.depthPacking=s.RGBADepthPacking,this.depthMaterial.blending=s.NoBlending,this.prepareMaskMaterial=this.getPrepareMaskMaterial(),this.prepareMaskMaterial.side=s.DoubleSide,this.prepareMaskMaterial.fragmentShader=u(this.prepareMaskMaterial.fragmentShader,this.renderCamera),this.renderTargetDepthBuffer=new s.WebGLRenderTarget(this.resolution.x,this.resolution.y),this.renderTargetDepthBuffer.texture.name="OutlinePass.depth",this.renderTargetDepthBuffer.texture.generateMipmaps=!1,this.renderTargetMaskDownSampleBuffer=new s.WebGLRenderTarget(n,o),this.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",this.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,this.renderTargetBlurBuffer1=new s.WebGLRenderTarget(n,o),this.renderTargetBlurBuffer1.texture.name="OutlinePass.blur1",this.renderTargetBlurBuffer1.texture.generateMipmaps=!1,this.renderTargetBlurBuffer2=new s.WebGLRenderTarget(Math.round(n/2),Math.round(o/2)),this.renderTargetBlurBuffer2.texture.name="OutlinePass.blur2",this.renderTargetBlurBuffer2.texture.generateMipmaps=!1,this.edgeDetectionMaterial=this.getEdgeDetectionMaterial(),this.renderTargetEdgeBuffer1=new s.WebGLRenderTarget(n,o),this.renderTargetEdgeBuffer1.texture.name="OutlinePass.edge1",this.renderTargetEdgeBuffer1.texture.generateMipmaps=!1,this.renderTargetEdgeBuffer2=new s.WebGLRenderTarget(Math.round(n/2),Math.round(o/2)),this.renderTargetEdgeBuffer2.texture.name="OutlinePass.edge2",this.renderTargetEdgeBuffer2.texture.generateMipmaps=!1;const a=4,h=4;this.separableBlurMaterial1=this.getSeperableBlurMaterial(a),this.separableBlurMaterial1.uniforms.texSize.value.set(n,o),this.separableBlurMaterial1.uniforms.kernelRadius.value=1,this.separableBlurMaterial2=this.getSeperableBlurMaterial(h),this.separableBlurMaterial2.uniforms.texSize.value.set(Math.round(n/2),Math.round(o/2)),this.separableBlurMaterial2.uniforms.kernelRadius.value=h,this.overlayMaterial=this.getOverlayMaterial();const d=ot;this.copyUniforms=s.UniformsUtils.clone(d.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new s.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:d.vertexShader,fragmentShader:d.fragmentShader,blending:s.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new s.Color,this.oldClearAlpha=1,this.fsQuad=new at(null),this.tempPulseColor1=new s.Color,this.tempPulseColor2=new s.Color,this.textureMatrix=new s.Matrix4;function u(p,k){const f=k.isPerspectiveCamera?"perspective":"orthographic";return p.replace(/DEPTH_TO_VIEW_Z/g,f+"DepthToViewZ")}}dispose(){this.renderTargetMaskBuffer.dispose(),this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetBlurBuffer1.dispose(),this.renderTargetBlurBuffer2.dispose(),this.renderTargetEdgeBuffer1.dispose(),this.renderTargetEdgeBuffer2.dispose(),this.depthMaterial.dispose(),this.prepareMaskMaterial.dispose(),this.edgeDetectionMaterial.dispose(),this.separableBlurMaterial1.dispose(),this.separableBlurMaterial2.dispose(),this.overlayMaterial.dispose(),this.materialCopy.dispose(),this.fsQuad.dispose()}setSize(e,i){this.renderTargetMaskBuffer.setSize(e,i),this.renderTargetDepthBuffer.setSize(e,i);let t=Math.round(e/this.downSampleRatio),r=Math.round(i/this.downSampleRatio);this.renderTargetMaskDownSampleBuffer.setSize(t,r),this.renderTargetBlurBuffer1.setSize(t,r),this.renderTargetEdgeBuffer1.setSize(t,r),this.separableBlurMaterial1.uniforms.texSize.value.set(t,r),t=Math.round(t/2),r=Math.round(r/2),this.renderTargetBlurBuffer2.setSize(t,r),this.renderTargetEdgeBuffer2.setSize(t,r),this.separableBlurMaterial2.uniforms.texSize.value.set(t,r)}changeVisibilityOfSelectedObjects(e){const i=this._visibilityCache;function t(r){r.isMesh&&(e===!0?r.visible=i.get(r):(i.set(r,r.visible),r.visible=e))}for(let r=0;r<this.selectedObjects.length;r++)this.selectedObjects[r].traverse(t)}changeVisibilityOfNonSelectedObjects(e){const i=this._visibilityCache,t=[];function r(o){o.isMesh&&t.push(o)}for(let o=0;o<this.selectedObjects.length;o++)this.selectedObjects[o].traverse(r);function n(o){if(o.isMesh||o.isSprite){let a=!1;for(let h=0;h<t.length;h++)if(t[h].id===o.id){a=!0;break}if(a===!1){const h=o.visible;(e===!1||i.get(o)===!0)&&(o.visible=e),i.set(o,h)}}else(o.isPoints||o.isLine)&&(e===!0?o.visible=i.get(o):(i.set(o,o.visible),o.visible=e))}this.renderScene.traverse(n)}updateTextureMatrix(){this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.renderCamera.projectionMatrix),this.textureMatrix.multiply(this.renderCamera.matrixWorldInverse)}render(e,i,t,r,n){if(this.selectedObjects.length>0){e.getClearColor(this._oldClearColor),this.oldClearAlpha=e.getClearAlpha();const o=e.autoClear;e.autoClear=!1,n&&e.state.buffers.stencil.setTest(!1),e.setClearColor(16777215,1),this.changeVisibilityOfSelectedObjects(!1);const a=this.renderScene.background;if(this.renderScene.background=null,this.renderScene.overrideMaterial=this.depthMaterial,e.setRenderTarget(this.renderTargetDepthBuffer),e.clear(),e.render(this.renderScene,this.renderCamera),this.changeVisibilityOfSelectedObjects(!0),this._visibilityCache.clear(),this.updateTextureMatrix(),this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskMaterial,this.prepareMaskMaterial.uniforms.cameraNearFar.value.set(this.renderCamera.near,this.renderCamera.far),this.prepareMaskMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.setRenderTarget(this.renderTargetMaskBuffer),e.clear(),e.render(this.renderScene,this.renderCamera),this.renderScene.overrideMaterial=null,this.changeVisibilityOfNonSelectedObjects(!0),this._visibilityCache.clear(),this.renderScene.background=a,this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.setRenderTarget(this.renderTargetMaskDownSampleBuffer),e.clear(),this.fsQuad.render(e),this.tempPulseColor1.copy(this.visibleEdgeColor),this.tempPulseColor2.copy(this.hiddenEdgeColor),this.pulsePeriod>0){const h=.625+Math.cos(performance.now()*.01/this.pulsePeriod)*.75/2;this.tempPulseColor1.multiplyScalar(h),this.tempPulseColor2.multiplyScalar(h)}this.fsQuad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value.set(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.visibleEdgeColor.value=this.tempPulseColor1,this.edgeDetectionMaterial.uniforms.hiddenEdgeColor.value=this.tempPulseColor2,e.setRenderTarget(this.renderTargetEdgeBuffer1),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.separableBlurMaterial1,this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=De.BlurDirectionX,this.separableBlurMaterial1.uniforms.kernelRadius.value=this.edgeThickness,e.setRenderTarget(this.renderTargetBlurBuffer1),e.clear(),this.fsQuad.render(e),this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetBlurBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=De.BlurDirectionY,e.setRenderTarget(this.renderTargetEdgeBuffer1),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.separableBlurMaterial2,this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial2.uniforms.direction.value=De.BlurDirectionX,e.setRenderTarget(this.renderTargetBlurBuffer2),e.clear(),this.fsQuad.render(e),this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetBlurBuffer2.texture,this.separableBlurMaterial2.uniforms.direction.value=De.BlurDirectionY,e.setRenderTarget(this.renderTargetEdgeBuffer2),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.overlayMaterial,this.overlayMaterial.uniforms.maskTexture.value=this.renderTargetMaskBuffer.texture,this.overlayMaterial.uniforms.edgeTexture1.value=this.renderTargetEdgeBuffer1.texture,this.overlayMaterial.uniforms.edgeTexture2.value=this.renderTargetEdgeBuffer2.texture,this.overlayMaterial.uniforms.patternTexture.value=this.patternTexture,this.overlayMaterial.uniforms.edgeStrength.value=this.edgeStrength,this.overlayMaterial.uniforms.edgeGlow.value=this.edgeGlow,this.overlayMaterial.uniforms.usePatternTexture.value=this.usePatternTexture,n&&e.state.buffers.stencil.setTest(!0),e.setRenderTarget(t),this.fsQuad.render(e),e.setClearColor(this._oldClearColor,this.oldClearAlpha),e.autoClear=o}this.renderToScreen&&(this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=t.texture,e.setRenderTarget(null),this.fsQuad.render(e))}getPrepareMaskMaterial(){return new s.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new s.Vector2(.5,.5)},textureMatrix:{value:null}},vertexShader:`#include <morphtarget_pars_vertex>
				#include <skinning_pars_vertex>

				varying vec4 projTexCoord;
				varying vec4 vPosition;
				uniform mat4 textureMatrix;

				void main() {

					#include <skinbase_vertex>
					#include <begin_vertex>
					#include <morphtarget_vertex>
					#include <skinning_vertex>
					#include <project_vertex>

					vPosition = mvPosition;

					vec4 worldPosition = vec4( transformed, 1.0 );

					#ifdef USE_INSTANCING

						worldPosition = instanceMatrix * worldPosition;

					#endif
					
					worldPosition = modelMatrix * worldPosition;

					projTexCoord = textureMatrix * worldPosition;

				}`,fragmentShader:`#include <packing>
				varying vec4 vPosition;
				varying vec4 projTexCoord;
				uniform sampler2D depthTexture;
				uniform vec2 cameraNearFar;

				void main() {

					float depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));
					float viewZ = - DEPTH_TO_VIEW_Z( depth, cameraNearFar.x, cameraNearFar.y );
					float depthTest = (-vPosition.z > viewZ) ? 1.0 : 0.0;
					gl_FragColor = vec4(0.0, depthTest, 1.0, 1.0);

				}`})}getEdgeDetectionMaterial(){return new s.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new s.Vector2(.5,.5)},visibleEdgeColor:{value:new s.Vector3(1,1,1)},hiddenEdgeColor:{value:new s.Vector3(1,1,1)}},vertexShader:`varying vec2 vUv;

				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;

				uniform sampler2D maskTexture;
				uniform vec2 texSize;
				uniform vec3 visibleEdgeColor;
				uniform vec3 hiddenEdgeColor;

				void main() {
					vec2 invSize = 1.0 / texSize;
					vec4 uvOffset = vec4(1.0, 0.0, 0.0, 1.0) * vec4(invSize, invSize);
					vec4 c1 = texture2D( maskTexture, vUv + uvOffset.xy);
					vec4 c2 = texture2D( maskTexture, vUv - uvOffset.xy);
					vec4 c3 = texture2D( maskTexture, vUv + uvOffset.yw);
					vec4 c4 = texture2D( maskTexture, vUv - uvOffset.yw);
					float diff1 = (c1.r - c2.r)*0.5;
					float diff2 = (c3.r - c4.r)*0.5;
					float d = length( vec2(diff1, diff2) );
					float a1 = min(c1.g, c2.g);
					float a2 = min(c3.g, c4.g);
					float visibilityFactor = min(a1, a2);
					vec3 edgeColor = 1.0 - visibilityFactor > 0.001 ? visibleEdgeColor : hiddenEdgeColor;
					gl_FragColor = vec4(edgeColor, 1.0) * vec4(d);
				}`})}getSeperableBlurMaterial(e){return new s.ShaderMaterial({defines:{MAX_RADIUS:e},uniforms:{colorTexture:{value:null},texSize:{value:new s.Vector2(.5,.5)},direction:{value:new s.Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:`varying vec2 vUv;

				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`#include <common>
				varying vec2 vUv;
				uniform sampler2D colorTexture;
				uniform vec2 texSize;
				uniform vec2 direction;
				uniform float kernelRadius;

				float gaussianPdf(in float x, in float sigma) {
					return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;
				}

				void main() {
					vec2 invSize = 1.0 / texSize;
					float sigma = kernelRadius/2.0;
					float weightSum = gaussianPdf(0.0, sigma);
					vec4 diffuseSum = texture2D( colorTexture, vUv) * weightSum;
					vec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);
					vec2 uvOffset = delta;
					for( int i = 1; i <= MAX_RADIUS; i ++ ) {
						float x = kernelRadius * float(i) / float(MAX_RADIUS);
						float w = gaussianPdf(x, sigma);
						vec4 sample1 = texture2D( colorTexture, vUv + uvOffset);
						vec4 sample2 = texture2D( colorTexture, vUv - uvOffset);
						diffuseSum += ((sample1 + sample2) * w);
						weightSum += (2.0 * w);
						uvOffset += delta;
					}
					gl_FragColor = diffuseSum/weightSum;
				}`})}getOverlayMaterial(){return new s.ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},patternTexture:{value:null},edgeStrength:{value:1},edgeGlow:{value:1},usePatternTexture:{value:0}},vertexShader:`varying vec2 vUv;

				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;

				uniform sampler2D maskTexture;
				uniform sampler2D edgeTexture1;
				uniform sampler2D edgeTexture2;
				uniform sampler2D patternTexture;
				uniform float edgeStrength;
				uniform float edgeGlow;
				uniform bool usePatternTexture;

				void main() {
					vec4 edgeValue1 = texture2D(edgeTexture1, vUv);
					vec4 edgeValue2 = texture2D(edgeTexture2, vUv);
					vec4 maskColor = texture2D(maskTexture, vUv);
					vec4 patternColor = texture2D(patternTexture, 6.0 * vUv);
					float visibilityFactor = 1.0 - maskColor.g > 0.0 ? 1.0 : 0.5;
					vec4 edgeValue = edgeValue1 + edgeValue2 * edgeGlow;
					vec4 finalColor = edgeStrength * maskColor.r * edgeValue;
					if(usePatternTexture)
						finalColor += + visibilityFactor * (1.0 - maskColor.r) * (1.0 - patternColor.r);
					gl_FragColor = finalColor;
				}`,blending:s.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0})}}De.BlurDirectionX=new s.Vector2(1,0);De.BlurDirectionY=new s.Vector2(0,1);const ai={uniforms:{tDiffuse:{value:null},resolution:{value:new s.Vector2(1/1024,1/512)}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`
	precision highp float;

	uniform sampler2D tDiffuse;

	uniform vec2 resolution;

	varying vec2 vUv;

	// FXAA 3.11 implementation by NVIDIA, ported to WebGL by Agost Biro (biro@archilogic.com)

	//----------------------------------------------------------------------------------
	// File:        es3-keplerFXAAassetsshaders/FXAA_DefaultES.frag
	// SDK Version: v3.00
	// Email:       gameworks@nvidia.com
	// Site:        http://developer.nvidia.com/
	//
	// Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.
	//
	// Redistribution and use in source and binary forms, with or without
	// modification, are permitted provided that the following conditions
	// are met:
	//  * Redistributions of source code must retain the above copyright
	//    notice, this list of conditions and the following disclaimer.
	//  * Redistributions in binary form must reproduce the above copyright
	//    notice, this list of conditions and the following disclaimer in the
	//    documentation and/or other materials provided with the distribution.
	//  * Neither the name of NVIDIA CORPORATION nor the names of its
	//    contributors may be used to endorse or promote products derived
	//    from this software without specific prior written permission.
	//
	// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ''AS IS'' AND ANY
	// EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
	// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
	// PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
	// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
	// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
	// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
	// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
	// OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
	// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
	// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
	//
	//----------------------------------------------------------------------------------

	#ifndef FXAA_DISCARD
			//
			// Only valid for PC OpenGL currently.
			// Probably will not work when FXAA_GREEN_AS_LUMA = 1.
			//
			// 1 = Use discard on pixels which don't need AA.
			//     For APIs which enable concurrent TEX+ROP from same surface.
			// 0 = Return unchanged color on pixels which don't need AA.
			//
			#define FXAA_DISCARD 0
	#endif

	/*--------------------------------------------------------------------------*/
	#define FxaaTexTop(t, p) texture2D(t, p, -100.0)
	#define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r), -100.0)
	/*--------------------------------------------------------------------------*/

	#define NUM_SAMPLES 5

	// assumes colors have premultipliedAlpha, so that the calculated color contrast is scaled by alpha
	float contrast( vec4 a, vec4 b ) {
			vec4 diff = abs( a - b );
			return max( max( max( diff.r, diff.g ), diff.b ), diff.a );
	}

	/*============================================================================

									FXAA3 QUALITY - PC

	============================================================================*/

	/*--------------------------------------------------------------------------*/
	vec4 FxaaPixelShader(
			vec2 posM,
			sampler2D tex,
			vec2 fxaaQualityRcpFrame,
			float fxaaQualityEdgeThreshold,
			float fxaaQualityinvEdgeThreshold
	) {
			vec4 rgbaM = FxaaTexTop(tex, posM);
			vec4 rgbaS = FxaaTexOff(tex, posM, vec2( 0.0, 1.0), fxaaQualityRcpFrame.xy);
			vec4 rgbaE = FxaaTexOff(tex, posM, vec2( 1.0, 0.0), fxaaQualityRcpFrame.xy);
			vec4 rgbaN = FxaaTexOff(tex, posM, vec2( 0.0,-1.0), fxaaQualityRcpFrame.xy);
			vec4 rgbaW = FxaaTexOff(tex, posM, vec2(-1.0, 0.0), fxaaQualityRcpFrame.xy);
			// . S .
			// W M E
			// . N .

			bool earlyExit = max( max( max(
					contrast( rgbaM, rgbaN ),
					contrast( rgbaM, rgbaS ) ),
					contrast( rgbaM, rgbaE ) ),
					contrast( rgbaM, rgbaW ) )
					< fxaaQualityEdgeThreshold;
			// . 0 .
			// 0 0 0
			// . 0 .

			#if (FXAA_DISCARD == 1)
					if(earlyExit) FxaaDiscard;
			#else
					if(earlyExit) return rgbaM;
			#endif

			float contrastN = contrast( rgbaM, rgbaN );
			float contrastS = contrast( rgbaM, rgbaS );
			float contrastE = contrast( rgbaM, rgbaE );
			float contrastW = contrast( rgbaM, rgbaW );

			float relativeVContrast = ( contrastN + contrastS ) - ( contrastE + contrastW );
			relativeVContrast *= fxaaQualityinvEdgeThreshold;

			bool horzSpan = relativeVContrast > 0.;
			// . 1 .
			// 0 0 0
			// . 1 .

			// 45 deg edge detection and corners of objects, aka V/H contrast is too similar
			if( abs( relativeVContrast ) < .3 ) {
					// locate the edge
					vec2 dirToEdge;
					dirToEdge.x = contrastE > contrastW ? 1. : -1.;
					dirToEdge.y = contrastS > contrastN ? 1. : -1.;
					// . 2 .      . 1 .
					// 1 0 2  ~=  0 0 1
					// . 1 .      . 0 .

					// tap 2 pixels and see which ones are "outside" the edge, to
					// determine if the edge is vertical or horizontal

					vec4 rgbaAlongH = FxaaTexOff(tex, posM, vec2( dirToEdge.x, -dirToEdge.y ), fxaaQualityRcpFrame.xy);
					float matchAlongH = contrast( rgbaM, rgbaAlongH );
					// . 1 .
					// 0 0 1
					// . 0 H

					vec4 rgbaAlongV = FxaaTexOff(tex, posM, vec2( -dirToEdge.x, dirToEdge.y ), fxaaQualityRcpFrame.xy);
					float matchAlongV = contrast( rgbaM, rgbaAlongV );
					// V 1 .
					// 0 0 1
					// . 0 .

					relativeVContrast = matchAlongV - matchAlongH;
					relativeVContrast *= fxaaQualityinvEdgeThreshold;

					if( abs( relativeVContrast ) < .3 ) { // 45 deg edge
							// 1 1 .
							// 0 0 1
							// . 0 1

							// do a simple blur
							return mix(
									rgbaM,
									(rgbaN + rgbaS + rgbaE + rgbaW) * .25,
									.4
							);
					}

					horzSpan = relativeVContrast > 0.;
			}

			if(!horzSpan) rgbaN = rgbaW;
			if(!horzSpan) rgbaS = rgbaE;
			// . 0 .      1
			// 1 0 1  ->  0
			// . 0 .      1

			bool pairN = contrast( rgbaM, rgbaN ) > contrast( rgbaM, rgbaS );
			if(!pairN) rgbaN = rgbaS;

			vec2 offNP;
			offNP.x = (!horzSpan) ? 0.0 : fxaaQualityRcpFrame.x;
			offNP.y = ( horzSpan) ? 0.0 : fxaaQualityRcpFrame.y;

			bool doneN = false;
			bool doneP = false;

			float nDist = 0.;
			float pDist = 0.;

			vec2 posN = posM;
			vec2 posP = posM;

			int iterationsUsed = 0;
			int iterationsUsedN = 0;
			int iterationsUsedP = 0;
			for( int i = 0; i < NUM_SAMPLES; i++ ) {
					iterationsUsed = i;

					float increment = float(i + 1);

					if(!doneN) {
							nDist += increment;
							posN = posM + offNP * nDist;
							vec4 rgbaEndN = FxaaTexTop(tex, posN.xy);
							doneN = contrast( rgbaEndN, rgbaM ) > contrast( rgbaEndN, rgbaN );
							iterationsUsedN = i;
					}

					if(!doneP) {
							pDist += increment;
							posP = posM - offNP * pDist;
							vec4 rgbaEndP = FxaaTexTop(tex, posP.xy);
							doneP = contrast( rgbaEndP, rgbaM ) > contrast( rgbaEndP, rgbaN );
							iterationsUsedP = i;
					}

					if(doneN || doneP) break;
			}


			if ( !doneP && !doneN ) return rgbaM; // failed to find end of edge

			float dist = min(
					doneN ? float( iterationsUsedN ) / float( NUM_SAMPLES - 1 ) : 1.,
					doneP ? float( iterationsUsedP ) / float( NUM_SAMPLES - 1 ) : 1.
			);

			// hacky way of reduces blurriness of mostly diagonal edges
			// but reduces AA quality
			dist = pow(dist, .5);

			dist = 1. - dist;

			return mix(
					rgbaM,
					rgbaN,
					dist * .5
			);
	}

	void main() {
			const float edgeDetectionQuality = .2;
			const float invEdgeDetectionQuality = 1. / edgeDetectionQuality;

			gl_FragColor = FxaaPixelShader(
					vUv,
					tDiffuse,
					resolution,
					edgeDetectionQuality, // [0,1] contrast needed, otherwise early discard
					invEdgeDetectionQuality
			);

	}
	`},li={uniforms:{tDiffuse:{value:null}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			vec4 tex = texture2D( tDiffuse, vUv );

			gl_FragColor = LinearTosRGB( tex );

		}`};var ue,Ce,Pe,Oe;class hi{constructor(e){ae(this,"title","模块-three后处理【原生版】");ae(this,"effectComposer",null);Ne(this,ue,null);Ne(this,Ce,null);Ne(this,Pe,null);Ne(this,Oe,null);ae(this,"destroy",()=>{if(this.closeRender(),this.effectComposer){let e=this.getEffectComposer();e.passes.forEach(i=>{E.SSDispose.dispose(i)}),E.SSDispose.dispose(e.copyPass),ke(this,ue,null),e.passes=[],e.renderTarget1.dispose(),e.renderTarget2.dispose(),e.writeBuffer=null,e.readBuffer=null,e.copyPass=null,e=null}});ae(this,"setup",()=>{const e=new rt(ai),i=this.ssThreeObject.threeRenderer.getPixelRatio();e.material.uniforms.resolution.value.x=1/(this.ssThreeObject.threeContainer.offsetWidth*i),e.material.uniforms.resolution.value.y=1/(this.ssThreeObject.threeContainer.offsetHeight*i),this.getEffectComposer().addPass(e)});ae(this,"addOutlineByObject3Ds",(e=[],i="#003354")=>{const t=this.getEffectComposer(),{threeContainer:r,threeScene:n,threeCamera:o}=this.ssThreeObject;J(this,Ce)===null&&ke(this,Ce,new oi(n,o)),t.passes.findIndex(a=>a===J(this,Ce))===-1&&t.addPass(J(this,Ce)),J(this,Pe)===null&&ke(this,Pe,new rt(li)),t.passes.findIndex(a=>a===J(this,Pe))===-1&&t.addPass(J(this,Pe)),J(this,ue)===null&&(ke(this,ue,new De({x:r.clientWidth,y:r.clientHeight},this.ssThreeObject.threeScene,this.ssThreeObject.threeCamera)),J(this,ue).edgeStrength=5,J(this,ue).edgeGlow=2,J(this,ue).edgeThickness=1,J(this,ue).pulsePeriod=3,J(this,ue).usePatternTexture=!1),J(this,ue).visibleEdgeColor=new L.Color(i),J(this,ue).hiddenEdgeColor=new L.Color(i),t.passes.findIndex(a=>a===J(this,ue))===-1&&t.addPass(J(this,ue)),J(this,ue).selectedObjects=e});ae(this,"removeOutline",()=>{const e=this.getEffectComposer();e.removePass(J(this,ue)),e.removePass(J(this,Ce)),e.removePass(J(this,Pe)),E.SSDispose.dispose(J(this,ue)),E.SSDispose.dispose(J(this,Pe)),E.SSDispose.dispose(J(this,Ce))});ae(this,"addBloom",()=>{const e=this.getEffectComposer();J(this,Oe)===null&&ke(this,Oe,new Ve(new L.Vector2(this.ssThreeObject.threeContainer.offsetWidth,this.ssThreeObject.threeContainer.offsetHeight))),e.passes.findIndex(i=>i===J(this,Oe))===-1&&this.effectComposer.addPass(J(this,Oe))});ae(this,"removeBloom",()=>{var e,i;(i=(e=this.effectComposer)==null?void 0:e.removePass)==null||i.call(e,J(this,Oe)),E.SSDispose.dispose(J(this,Oe))});ae(this,"addMaskBoxByObject3Ds",(e,i)=>{const t=new L.MeshStandardMaterial({name:"tempmask",transparent:!0,opacity:.3,color:"#00ffff",depthWrite:!1,userData:{temp_isMask:!0},...i});e.forEach(r=>{var n;if(r.isObject3D){if((n=r.userData)!=null&&n.tempMask){r.userData.tempMask.visible=!0,r.userData.tempMask.position.copy(r.position);return}const o=r.clone();o.name=`${r.name}_tempmask`,o.traverse(a=>{a.type==="Mesh"&&(a.material=t)}),r.parent.add(o),r.userData.tempMask=o}})});ae(this,"removeMaskBox",(e=[])=>{e.forEach(i=>{var t,r,n;i.isObject3D&&(r=(t=i.userData)==null?void 0:t.tempMask)!=null&&r.isObject3D&&(E.SSDispose.dispose((n=i.userData)==null?void 0:n.tempMask),i.userData.tempMask.removeFromParent(),i.userData.tempMask=null)})});ae(this,"getEffectComposer",()=>{if(this.effectComposer instanceof Mt)return this.effectComposer;const{threeRenderer:e,threeContainer:i}=this.ssThreeObject,t=new Mt(e),r=i;return t.setSize(r.clientWidth,r.clientHeight),this.effectComposer=t,this.openRender(),t});ae(this,"openRender",()=>{this.ssThreeObject.cancelRender(),E.SSThreeLoop.add(()=>{this.effectComposer.passes.length>0&&this.effectComposer.render()},"postProcess update")});ae(this,"closeRender",()=>{this.ssThreeObject.render(),E.SSThreeLoop.removeId("postProcess update")});this.ssThreeObject=e}moduleMount(){}getModuleConfig(){return{edgeStrength:5,edgeGlow:2,edgeThickness:1,pulsePeriod:3}}moduleGuiChange(e){console.log(" gui params ",e)}}ue=new WeakMap,Ce=new WeakMap,Pe=new WeakMap,Oe=new WeakMap;const ci=500*1024*1024,It="threeJsdb",st=1,ve=[{name:"model",dbVersion:st,columns:[{name:"model_name",primarykey:!0,unique:!1,autoIncrement:!1,type:"add"},{name:"model_type",type:"add"},{name:"model_path",type:"add"},{name:"size",type:"add"},{name:"create_time",type:"add"},{name:"update_time",type:"add"}]},{name:"modelfile",dbVersion:st,columns:[{name:"model_name",primarykey:!0,unique:!1,autoIncrement:!1,type:"add"},{name:"data",type:"add"}]}],_t=`${It}_size`;class di{constructor(){this.targetDataBase=null,this.createDataTables=(e,i=ve)=>{for(let t=0;t<i.length;t++){const r=i[t],{name:n,columns:o=[],dbVersion:a}=r;if(a===e.version)if(e.objectStoreNames.contains(n)){const h=e.transaction(n).objectStore(n);o.forEach(d=>{d.type==="add"?h.createIndex(d.name,d.name,{unique:d.unique}):d.type==="del"&&h.deleteIndex(d.name)})}else{const h=o.filter(u=>u.primarykey===!0).map(u=>u.name)||[],d=e.createObjectStore(n,{keyPath:h[0]});o.forEach(u=>{u.type==="add"&&d.createIndex(u.name,u.name,{unique:u.unique})})}}},this.addDbObserver=e=>{e instanceof IDBDatabase&&(e.onabort=i=>{console.log(" 数据库被终止操作 ",i)},e.onclose=i=>{console.log(" 数据库被关闭事件 ",i)},e.onerror=i=>{console.log(" 数据库出错事件 ",i)},e.onversionchange=i=>{console.log(" 数据库版本改变事件 ",i)})},this.insertModel=(e,i)=>this.autoLRU(i.byteLength).then(()=>this.open().then(t=>new Promise((r,n)=>{const o=ve[0].name,a=ve[1].name,h=t.transaction([o,a],"readwrite"),d=h.objectStore(o),u=h.objectStore(a);d.add({model_name:e,model_type:"",model_path:e,size:i.byteLength,create_time:new Date().valueOf(),update_time:new Date().valueOf()}),u.add({model_name:e,data:i}),h.oncomplete=()=>{this.updateTotalSize(i.byteLength),r(!0)},h.onerror=p=>{n(p)},h.onabort=p=>{n(p)}}))),this.getModel=e=>{const i=ve[1].name;return this.get(e,i).then(t=>{if(t){const r=ve[0].name;this.get(e,r).then(n=>n?(n.update_time=new Date().valueOf(),this.update(n,r)):null)}return t})},this.deleteModels=e=>this.open().then(i=>e.length===0?Promise.resolve(!1):new Promise((t,r)=>{const n=ve[0].name,o=ve[1].name,a=i.transaction([n,o],"readwrite"),h=a.objectStore(n),d=a.objectStore(o);e.forEach(u=>{h.delete(u),d.delete(u)}),a.oncomplete=()=>{t(!0)},a.onerror=u=>{r(u)},a.onabort=u=>{r(u)}})),this.get=(e,i=ve[1].name)=>new Promise((t,r)=>{this.open().then(n=>{if(n instanceof IDBDatabase){const h=n.transaction(i,"readwrite").objectStore(i).get(e);h.onsuccess=()=>{t(h.result)},h.onerror=d=>{r(d)}}})}),this.update=(e,i=ve[1].name)=>new Promise((t,r)=>{this.open().then(n=>{if(n instanceof IDBDatabase){const h=n.transaction(i,"readwrite").objectStore(i).put(e);h.onsuccess=()=>{t(h.result)},h.onerror=d=>{r(d)}}})}),this.delete=(e="",i=ve[1].name)=>new Promise((t,r)=>{this.open().then(n=>{if(n instanceof IDBDatabase){const h=n.transaction(i,"readwrite").objectStore(i).delete(e);h.onsuccess=()=>{t(h.result)},h.onerror=d=>{r(d)}}})}),this.autoLRU=(e=0)=>{const i=this.getTotalSize();let t=ci-(i+e);return t>0?Promise.resolve():(t=Math.abs(t),this.open().then(r=>new Promise((n,o)=>{const a=ve[0].name,u=r.transaction([a],"readwrite").objectStore(a).getAll();u.onsuccess=()=>{const k=(u.result||[]).sort((c,M)=>c.update_time-M.update_time),f=[];let v=0,m=0;for(;t>v;){const c=k[m];v+=c.size,m+=1,f.push(c.model_name)}n({modelNames:f,reduceSize:v})},u.onerror=p=>{o(p)}})).then(r=>{const{modelNames:n,reduceSize:o}=r;return this.deleteModels(n).then(()=>{this.updateTotalSize(o*-1)})}))},this.getTotalSize=()=>{const e=localStorage.getItem(_t);return e?parseInt(e,10):0},this.updateTotalSize=(e=0)=>{const i=this.getTotalSize();localStorage.setItem(_t,`${i+e}`)}}destory(){var e;(e=this.targetDataBase)==null||e.close(),this.targetDataBase=null}open(){return this.targetDataBase instanceof IDBDatabase?Promise.resolve(this.targetDataBase):new Promise((e,i)=>{const t=window.indexedDB.open(It,st);t.onsuccess=()=>{const r=t.result;this.targetDataBase=r,this.addDbObserver(r),e(this.targetDataBase)},t.onerror=r=>{console.log("【LOG】数据库打开失败 ",r),this.targetDataBase=null,i(r)},t.onupgradeneeded=r=>{console.log("【LOG】数据库版本不一致 ",r.target);const n=r.target.result;this.createDataTables(n,ve)},t.onblocked=r=>{console.log("【LOG】当前数据库连接暂未关闭 ",r)}})}}class ui{constructor(e){this.threeLoadingManager=null,this.db=null,this.messageQueue=null,this._progressBgElement=null,this._progressTextElement=null,this._progressElement=null,this.addProgressView=i=>{if(document.getElementById("threeloadingprogress"))return;const t=document.createElement("div");t.id="threeloadingprogress",t.style.height="20px",t.style.borderRadius="10px",t.style.border="1px solid #00E8ff",t.style.padding="1px",t.style.width="15%",t.style.position="absolute",t.style.bottom="10%",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.transition="opacity 1s linear",t.style.opacity="0",i.appendChild(t),this._progressBgElement=t;const r=document.createElement("div");r.style.backgroundColor="#2fa1d6",r.style.maxWidth="100%",r.style.height="100%",r.style.borderRadius="9px",t.appendChild(r),this._progressElement=r;const n=document.createElement("div");n.innerText="模型渲染中...",n.style.position="absolute",n.style.bottom="100%",n.style.color="#2fa1d6",n.style.width="100%",n.style.height="30px",n.style.lineHeight="30px",n.style.textAlign="center",n.style.fontSize="16px",t.appendChild(n),this._progressTextElement=n,this.threeLoadingManager.onStart=(o,a,h)=>{t.style.opacity="1",n.innerText="模型渲染中..."},this.threeLoadingManager.onLoad=()=>{t.style.opacity="0"},this.threeLoadingManager.onProgress=(o,a,h)=>{r.style.width=`${a/h*100}%`},this.threeLoadingManager.onError=o=>{t.style.opacity="0"}},this.removeProgressView=()=>{this._progressBgElement&&this._progressBgElement.remove()},this.downloadUrl=i=>fetch(i,{method:"GET"}).then(t=>{if(t.status===200){let r=null;try{r=t.arrayBuffer()}catch{r=t.blob()}return r}return Promise.reject(new Error("model fetch error"))}),this.downloadUrl2=async(i,t)=>{const r=await fetch(i,{method:"GET",headers:{responseType:"arraybuffer"}}),n=r.body.getReader(),o=+r.headers.get("Content-Length");let a=0;const h=[];let d=!0,u=0;for(;d;){const{done:f,value:v}=await n.read();if(f){d=!1,t==null||t(1,h);break}h.push(v),a+=v.length,u+=.01,u=Math.min(u,.99),t==null||t(o>=0?u:a/o,h)}const p=new Uint8Array(a);let k=0;return h.forEach(f=>{p.set(f,k),k+=f.length}),p.buffer},this.getModelFilePathByUrl=i=>i.startsWith("data:")||i.startsWith("blob:")?Promise.resolve(i):this.db.getModel(i).then(t=>t?URL.createObjectURL(new Blob([t==null?void 0:t.data])):i),this.getModelDataByUrl=i=>this.db.getModel(i).then(t=>t?t.data:this.downloadUrl2(i,r=>{this._progressBgElement&&(this._progressBgElement.style.opacity="1"),this._progressTextElement&&(this._progressTextElement.innerText="模型下载中..."),this._progressElement&&(this._progressElement.style.width=`${r*100}%`)}).then(r=>(this.db.insertModel(i,r),r))),this.threeLoadingManager=new L.LoadingManager,this.db=new di,this.messageQueue=new Bt,this.threeLoadingManager.setURLModifier(i=>i),this.addProgressView(e)}destory(){var e,i;(e=this.db)==null||e.destory(),this.db=null,this.threeLoadingManager=null,this.removeProgressView(),(i=this.messageQueue)==null||i.destory(),this.messageQueue=null}}class fi{constructor(){this.ssThreeObject=null,this.ssModuleCenter=null,this.ssMessageQueue=null,this.ssTransformControl=null,this.ssPostProcessModule=null,this.threeScene=null,this.threeCamera=null,this.threeAmbientLight=null,this.threeRenderer=null,this.threeEvent=null,this.ssLoadingManager=null,this._axisControlHelper=null,this._statsJs=null,this.setup=e=>{let i=null;if(typeof e=="string"?i=document.getElementById(e):e instanceof HTMLElement&&(i=e),!(i instanceof HTMLElement))return null;if(!ct.isWebGLAvailable()){const d=ct.getWebGLErrorMessage();return i.appendChild(d),null}const t=new L.Scene;this.threeScene=t;const r=i.offsetWidth/i.offsetHeight,n=new L.PerspectiveCamera(45,r,.1,2e4);n.position.set(10,10,10),this.threeCamera=n;const o=this._addRender();i.append(o.domElement),this.threeRenderer=o;const a=new L.AmbientLight(new L.Color(16777215),1);t.add(a),this.threeAmbientLight=a;const h=this._addOrbitControl(n,i);return this.threeEvent=new E.SSEvent(i),this.ssLoadingManager=new ui(i),E.SSThreeLoop.setup(),this.ssThreeObject=new Lt({container:i,scene:t,camera:n,control:h,renderer:o}),this.ssThreeObject.autoWindowResize(),this.ssThreeObject.renderLoop(),this.ssModuleCenter=new At(this.ssThreeObject),this.ssPostProcessModule=new hi(this.ssThreeObject),this.ssTransformControl=new ii(this.ssThreeObject),E.SSThreeLoop.add(()=>{this.ssThreeObject.threeOrbitControl&&this.ssThreeObject.threeOrbitControl.update()},"control update"),t},this.addSkyOld=(e=[])=>{const i=new L.PMREMGenerator(this.threeRenderer),t=new L.CubeTextureLoader(this.ssLoadingManager.threeLoadingManager);return new Promise((r,n)=>{t.load(e,o=>{const a=i.fromCubemap(o).texture;this.threeScene.environment=a,this.threeScene.background=a,i.dispose(),r(o)},null,o=>{i.dispose(),n(o)})})},this.addSun=()=>{const e=new L.Vector3,i=new $e;i.name="Sky",i.scale.setScalar(1e4),this.threeScene.add(i);const t=i.material.uniforms;t.turbidity.value=10,t.rayleigh.value=2,t.mieCoefficient.value=.005,t.mieDirectionalG.value=.8;const r={elevation:10,azimuth:76,turbidity:0,rayleigh:.1,mieCoefficient:.005,mieDirectionalG:.8};return(()=>{i.material.uniforms.turbidity.value=r.turbidity,i.material.uniforms.rayleigh.value=r.rayleigh,i.material.uniforms.mieCoefficient.value=r.mieCoefficient,i.material.uniforms.mieDirectionalG.value=r.mieDirectionalG;const o=L.MathUtils.degToRad(90-r.elevation),a=L.MathUtils.degToRad(r.azimuth);e.setFromSphericalCoords(1,o,a),i.material.uniforms.sunPosition.value.copy(e)})(),i},this.addHDR=e=>{const i=new L.PMREMGenerator(this.threeRenderer);if(e.length===1)return new Promise((r,n)=>{new Dt(this.ssLoadingManager.threeLoadingManager).load(e[0],a=>{const h=i.fromEquirectangular(a).texture;this.threeScene.background=h,this.threeScene.environment=h,i.dispose(),r(a)},null,a=>{i.dispose(),n(a)})});const t=new Qt(this.ssLoadingManager.threeLoadingManager);return new Promise((r,n)=>{t.load(e,o=>{const a=i.fromCubemap(o).texture;this.threeScene.environment=a,this.threeScene.background=a,i.dispose(),r(o)},null,o=>{i.dispose(),n(o)})})},this._addRender=()=>{const e=new L.WebGLRenderer({antialias:!0});return e.shadowMap.enabled=!0,e.shadowMap.type=L.PCFSoftShadowMap,e.setPixelRatio(window.devicePixelRatio),e.setClearColor("white",0),e.autoClear=!0,e},this.addDymaicDebug=()=>{this._addAxisControl(this.threeScene),this._addStatAnalyse()},this.removeDymaicDebug=()=>{this._removeAxisControl(),this._removeStatAnalyse()},this.loadModelQueue=(e,i,t,r)=>{if(e.length===0){i==null||i([]);return}this.ssMessageQueue===null&&(this.ssMessageQueue=new Bt);const n=[];e.forEach(o=>{let a=Promise.resolve();switch(o.type){case"obj":a=E.SSLoader.loadObj(o.obj,o.mtl,null,this.ssLoadingManager.threeLoadingManager);break;case"fbx":a=this.loadFbx(o.fbx);break;case"gltf":a=this.loadGltf(o.gltf);break;case"draco":a=this.loadGltfDraco(o.draco);break;case"opt":a=this.loadGltfOptKTX(o.opt);break}this.ssMessageQueue.add(()=>{a.then(h=>{var d;t==null||t(o,h),h instanceof L.Object3D?h.traverse(u=>{u.receiveShadow=!0,u.castShadow=!0}):h.scene instanceof L.Object3D&&h.scene.traverse(u=>{u.receiveShadow=!0,u.castShadow=!0}),n.push(h),r==null||r(o,h),(d=this.ssMessageQueue)==null||d.remove()}).catch(h=>{var d;console.log(" 模型渲染失败 ",o,h),(d=this.ssMessageQueue)==null||d.remove()})})}),this.ssMessageQueue.add(()=>{i==null||i(n),this.ssMessageQueue.remove()})},this.getModelDirectory=(e="")=>{const i=e.split("/");return i.pop(),`${i.join("/")}/`},this.loadFbx=e=>this.ssLoadingManager.getModelDataByUrl(e).then(i=>E.SSLoader.loadFbxBuffer(i,this.getModelDirectory(e),this.ssLoadingManager.threeLoadingManager)),this.loadGltf=e=>this.ssLoadingManager.getModelDataByUrl(e).then(i=>E.SSLoader.loadGltfBuffer(i,this.getModelDirectory(e),this.ssLoadingManager.threeLoadingManager)),this.loadGltfDraco=e=>this.ssLoadingManager.getModelDataByUrl(e).then(i=>E.SSLoader.loadGltfDracoBuffer(i,this.getModelDirectory(e),this.ssLoadingManager.threeLoadingManager)),this.loadGltfOptKTX=e=>this.ssLoadingManager.getModelDataByUrl(e).then(i=>E.SSLoader.loadGltfOptKTXBuffer(i,this.getModelDirectory(e),this.ssLoadingManager.threeLoadingManager)),this._addOrbitControl=(e,i)=>{const t=new it(e||this.threeCamera,i||this.ssThreeObject.threeContainer);return t.enableDamping=!0,t.dampingFactor=.25,t.enableZoom=!0,t.autoRotate=!1,t.autoRotateSpeed=2,t.minDistance=2,t.maxDistance=1e3,t.enablePan=!0,t},this._removeOrbitControl=()=>{this.ssThreeObject.threeOrbitControl!==null&&(this.ssThreeObject.threeOrbitControl.dispose(),this.ssThreeObject.threeOrbitControl=null)},this._addAxisControl=(e=this.threeScene)=>{const i=new L.AxesHelper(100);e.add(i),this._axisControlHelper=i},this._removeAxisControl=()=>{this._axisControlHelper!==null&&(this._axisControlHelper.dispose(),this._axisControlHelper=null)},this._addStatAnalyse=(e=this.ssThreeObject.threeContainer)=>{const i=new E.Stats;this._statsJs=i,i.showPanel(0),e.appendChild(i.dom),i.dom.style.position="absolute",i.dom.style.top="unset",i.dom.style.bottom="0px",E.SSThreeLoop.add(()=>{i.update()},"fps render")},this._removeStatAnalyse=()=>{this._statsJs!==null&&(this._statsJs.dom.remove(),this._statsJs.end(),this._statsJs=null,E.SSThreeLoop.removeId("fps render"))},this.getModelsByPoint=(e,i,t)=>this.ssThreeObject.getModelsByPoint(e,i,t)}destroy(e=!0){var i,t,r,n,o;(i=this.ssTransformControl)==null||i.destory(),this.ssTransformControl=null,(t=this.ssThreeObject)==null||t.destory(),(r=this.ssMessageQueue)==null||r.destory(),this.ssMessageQueue=null,(n=this.ssLoadingManager)==null||n.destory(),this.ssLoadingManager=null,e&&E.SSThreeLoop.destory(),(o=this.ssModuleCenter)==null||o.destroy(),this.ssModuleCenter=null,this._removeOrbitControl(),this.threeEvent.destory(),this.threeEvent=null,this.threeScene!==null&&(E.SSDispose.dispose(this.threeScene),this.threeRenderer.info.programs.length!==0?console.log("scene material has not released",this.threeRenderer.info):this.threeRenderer.info.memory.geometries?console.log("scene geometries has not released",this.threeRenderer.info):this.threeRenderer.info.memory.textures&&console.log("scene textures has not released",this.threeRenderer.info)),this.threeRenderer!==null&&(this.threeRenderer.dispose(),this.threeRenderer.forceContextLoss(),this.ssThreeObject.threeContainer.removeChild(this.threeRenderer.domElement))}setEye(e,i,t=!0,r=.5,n){this.ssThreeObject.setEye(e,i,t,r,n)}getEye(){return this.ssThreeObject.getEye()}}const pi={SSLinearGradientMaterial:E.SSLinearGradientMaterial,SSLightScanMaterial:E.SSLightScanMaterial};class zt extends s.Object3D{constructor(e=document.createElement("div")){super(),this.isCSS2DObject=!0,this.element=e,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.center=new s.Vector2(.5,.5),this.addEventListener("removed",function(){this.traverse(function(i){i.element instanceof Element&&i.element.parentNode!==null&&i.element.parentNode.removeChild(i.element)})})}copy(e,i){return super.copy(e,i),this.element=e.element.cloneNode(!0),this.center=e.center,this}}const Fe=new s.Vector3,Tt=new s.Matrix4,Et=new s.Matrix4,Ct=new s.Vector3,Pt=new s.Vector3;class mi{constructor(e={}){const i=this;let t,r,n,o;const a={objects:new WeakMap},h=e.element!==void 0?e.element:document.createElement("div");h.style.overflow="hidden",this.domElement=h,this.getSize=function(){return{width:t,height:r}},this.render=function(f,v){f.matrixWorldAutoUpdate===!0&&f.updateMatrixWorld(),v.parent===null&&v.matrixWorldAutoUpdate===!0&&v.updateMatrixWorld(),Tt.copy(v.matrixWorldInverse),Et.multiplyMatrices(v.projectionMatrix,Tt),d(f,f,v),k(f)},this.setSize=function(f,v){t=f,r=v,n=t/2,o=r/2,h.style.width=f+"px",h.style.height=v+"px"};function d(f,v,m){if(f.isCSS2DObject){Fe.setFromMatrixPosition(f.matrixWorld),Fe.applyMatrix4(Et);const c=f.visible===!0&&Fe.z>=-1&&Fe.z<=1&&f.layers.test(m.layers)===!0;if(f.element.style.display=c===!0?"":"none",c===!0){f.onBeforeRender(i,v,m);const P=f.element;P.style.transform="translate("+-100*f.center.x+"%,"+-100*f.center.y+"%)translate("+(Fe.x*n+n)+"px,"+(-Fe.y*o+o)+"px)",P.parentNode!==h&&h.appendChild(P),f.onAfterRender(i,v,m)}const M={distanceToCameraSquared:u(m,f)};a.objects.set(f,M)}for(let c=0,M=f.children.length;c<M;c++)d(f.children[c],v,m)}function u(f,v){return Ct.setFromMatrixPosition(f.matrixWorld),Pt.setFromMatrixPosition(v.matrixWorld),Ct.distanceToSquared(Pt)}function p(f){const v=[];return f.traverse(function(m){m.isCSS2DObject&&v.push(m)}),v}function k(f){const v=p(f).sort(function(c,M){if(c.renderOrder!==M.renderOrder)return M.renderOrder-c.renderOrder;const P=a.objects.get(c).distanceToCameraSquared,g=a.objects.get(M).distanceToCameraSquared;return P-g}),m=v.length;for(let c=0,M=v.length;c<M;c++)v[c].element.style.zIndex=m-c}}}const Ot=new s.Vector3,gi=new s.Quaternion,Rt=new s.Vector3;class yi extends s.Object3D{constructor(e=document.createElement("div")){super(),this.isCSS3DObject=!0,this.element=e,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.addEventListener("removed",function(){this.traverse(function(i){i.element instanceof Element&&i.element.parentNode!==null&&i.element.parentNode.removeChild(i.element)})})}copy(e,i){return super.copy(e,i),this.element=e.element.cloneNode(!0),this}}const we=new s.Matrix4,vi=new s.Matrix4;class bi{constructor(e={}){const i=this;let t,r,n,o;const a={camera:{fov:0,style:""},objects:new WeakMap},h=e.element!==void 0?e.element:document.createElement("div");h.style.overflow="hidden",this.domElement=h;const d=document.createElement("div");d.style.transformOrigin="0 0",d.style.pointerEvents="none",h.appendChild(d);const u=document.createElement("div");u.style.transformStyle="preserve-3d",d.appendChild(u),this.getSize=function(){return{width:t,height:r}},this.render=function(m,c){const M=c.projectionMatrix.elements[5]*o;a.camera.fov!==M&&(d.style.perspective=c.isPerspectiveCamera?M+"px":"",a.camera.fov=M),c.view&&c.view.enabled?(d.style.transform=`translate( ${-c.view.offsetX*(t/c.view.width)}px, ${-c.view.offsetY*(r/c.view.height)}px )`,d.style.transform+=`scale( ${c.view.fullWidth/c.view.width}, ${c.view.fullHeight/c.view.height} )`):d.style.transform="",m.matrixWorldAutoUpdate===!0&&m.updateMatrixWorld(),c.parent===null&&c.matrixWorldAutoUpdate===!0&&c.updateMatrixWorld();let P,g;c.isOrthographicCamera&&(P=-(c.right+c.left)/2,g=(c.top+c.bottom)/2);const x=c.view&&c.view.enabled?c.view.height/c.view.fullHeight:1,A=(c.isOrthographicCamera?`scale( ${x} )scale(`+M+")translate("+p(P)+"px,"+p(g)+"px)"+k(c.matrixWorldInverse):`scale( ${x} )translateZ(`+M+"px)"+k(c.matrixWorldInverse))+"translate("+n+"px,"+o+"px)";a.camera.style!==A&&(u.style.transform=A,a.camera.style=A),v(m,m,c)},this.setSize=function(m,c){t=m,r=c,n=t/2,o=r/2,h.style.width=m+"px",h.style.height=c+"px",d.style.width=m+"px",d.style.height=c+"px",u.style.width=m+"px",u.style.height=c+"px"};function p(m){return Math.abs(m)<1e-10?0:m}function k(m){const c=m.elements;return"matrix3d("+p(c[0])+","+p(-c[1])+","+p(c[2])+","+p(c[3])+","+p(c[4])+","+p(-c[5])+","+p(c[6])+","+p(c[7])+","+p(c[8])+","+p(-c[9])+","+p(c[10])+","+p(c[11])+","+p(c[12])+","+p(-c[13])+","+p(c[14])+","+p(c[15])+")"}function f(m){const c=m.elements;return"translate(-50%,-50%)"+("matrix3d("+p(c[0])+","+p(c[1])+","+p(c[2])+","+p(c[3])+","+p(-c[4])+","+p(-c[5])+","+p(-c[6])+","+p(-c[7])+","+p(c[8])+","+p(c[9])+","+p(c[10])+","+p(c[11])+","+p(c[12])+","+p(c[13])+","+p(c[14])+","+p(c[15])+")")}function v(m,c,M,P){if(m.isCSS3DObject){const g=m.visible===!0&&m.layers.test(M.layers)===!0;if(m.element.style.display=g===!0?"":"none",g===!0){m.onBeforeRender(i,c,M);let x;m.isCSS3DSprite?(we.copy(M.matrixWorldInverse),we.transpose(),m.rotation2D!==0&&we.multiply(vi.makeRotationZ(m.rotation2D)),m.matrixWorld.decompose(Ot,gi,Rt),we.setPosition(Ot),we.scale(Rt),we.elements[3]=0,we.elements[7]=0,we.elements[11]=0,we.elements[15]=1,x=f(we)):x=f(m.matrixWorld);const S=m.element,A=a.objects.get(m);if(A===void 0||A.style!==x){S.style.transform=x;const Y={style:x};a.objects.set(m,Y)}S.parentNode!==u&&u.appendChild(S),m.onAfterRender(i,c,M)}}for(let g=0,x=m.children.length;g<x;g++)v(m.children[g],c,M)}}}class Si{constructor(){this.id=0,this.object=null,this.z=0,this.renderOrder=0}}class kt{constructor(){this.id=0,this.v1=new je,this.v2=new je,this.v3=new je,this.normalModel=new s.Vector3,this.vertexNormalsModel=[new s.Vector3,new s.Vector3,new s.Vector3],this.vertexNormalsLength=0,this.color=new s.Color,this.material=null,this.uvs=[new s.Vector2,new s.Vector2,new s.Vector2],this.z=0,this.renderOrder=0}}class je{constructor(){this.position=new s.Vector3,this.positionWorld=new s.Vector3,this.positionScreen=new s.Vector4,this.visible=!0}copy(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)}}class Ft{constructor(){this.id=0,this.v1=new je,this.v2=new je,this.vertexColors=[new s.Color,new s.Color],this.material=null,this.z=0,this.renderOrder=0}}class jt{constructor(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new s.Vector2,this.material=null,this.renderOrder=0}}class xi{constructor(){let e,i,t=0,r,n,o=0,a,h,d=0,u,p,k=0,f,v,m=0,c;const M={objects:[],lights:[],elements:[]},P=new s.Vector3,g=new s.Vector4,x=new s.Box3(new s.Vector3(-1,-1,-1),new s.Vector3(1,1,1)),S=new s.Box3,A=new Array(3),Y=new s.Matrix4,j=new s.Matrix4,R=new s.Matrix4,G=new s.Frustum,V=[],oe=[],fe=[],ie=[],K=[];function pe(){const b=[],U=[],w=[];let C=null;const F=new s.Matrix3;function B(_){C=_,F.getNormalMatrix(C.matrixWorld),b.length=0,U.length=0,w.length=0}function T(_){const N=_.position,Q=_.positionWorld,q=_.positionScreen;Q.copy(N).applyMatrix4(c),q.copy(Q).applyMatrix4(j);const me=1/q.w;q.x*=me,q.y*=me,q.z*=me,_.visible=q.x>=-1&&q.x<=1&&q.y>=-1&&q.y<=1&&q.z>=-1&&q.z<=1}function D(_,N,Q){r=Se(),r.position.set(_,N,Q),T(r)}function H(_,N,Q){b.push(_,N,Q)}function ee(_,N,Q){U.push(_,N,Q)}function le(_,N){w.push(_,N)}function I(_,N,Q){return _.visible===!0||N.visible===!0||Q.visible===!0?!0:(A[0]=_.positionScreen,A[1]=N.positionScreen,A[2]=Q.positionScreen,x.intersectsBox(S.setFromPoints(A)))}function Z(_,N,Q){return(Q.positionScreen.x-_.positionScreen.x)*(N.positionScreen.y-_.positionScreen.y)-(Q.positionScreen.y-_.positionScreen.y)*(N.positionScreen.x-_.positionScreen.x)<0}function de(_,N){const Q=oe[_],q=oe[N];Q.positionScreen.copy(Q.position).applyMatrix4(R),q.positionScreen.copy(q.position).applyMatrix4(R),Ae(Q.positionScreen,q.positionScreen)===!0&&(Q.positionScreen.multiplyScalar(1/Q.positionScreen.w),q.positionScreen.multiplyScalar(1/q.positionScreen.w),u=Me(),u.id=C.id,u.v1.copy(Q),u.v2.copy(q),u.z=Math.max(Q.positionScreen.z,q.positionScreen.z),u.renderOrder=C.renderOrder,u.material=C.material,C.material.vertexColors&&(u.vertexColors[0].fromArray(U,_*3),u.vertexColors[1].fromArray(U,N*3)),M.elements.push(u))}function z(_,N,Q,q){const me=oe[_],l=oe[N],O=oe[Q];if(I(me,l,O)!==!1&&(q.side===s.DoubleSide||Z(me,l,O)===!0)){a=Le(),a.id=C.id,a.v1.copy(me),a.v2.copy(l),a.v3.copy(O),a.z=(me.positionScreen.z+l.positionScreen.z+O.positionScreen.z)/3,a.renderOrder=C.renderOrder,P.subVectors(O.position,l.position),g.subVectors(me.position,l.position),P.cross(g),a.normalModel.copy(P),a.normalModel.applyMatrix3(F).normalize();for(let $=0;$<3;$++){const he=a.vertexNormalsModel[$];he.fromArray(b,arguments[$]*3),he.applyMatrix3(F).normalize(),a.uvs[$].fromArray(w,arguments[$]*2)}a.vertexNormalsLength=3,a.material=q,q.vertexColors&&a.color.fromArray(U,_*3),M.elements.push(a)}}return{setObject:B,projectVertex:T,checkTriangleVisibility:I,checkBackfaceCulling:Z,pushVertex:D,pushNormal:H,pushColor:ee,pushUv:le,pushLine:de,pushTriangle:z}}const W=new pe;function X(b){if(b.visible===!1)return;if(b.isLight)M.lights.push(b);else if(b.isMesh||b.isLine||b.isPoints){if(b.material.visible===!1||b.frustumCulled===!0&&G.intersectsObject(b)===!1)return;re(b)}else if(b.isSprite){if(b.material.visible===!1||b.frustumCulled===!0&&G.intersectsSprite(b)===!1)return;re(b)}const U=b.children;for(let w=0,C=U.length;w<C;w++)X(U[w])}function re(b){e=be(),e.id=b.id,e.object=b,P.setFromMatrixPosition(b.matrixWorld),P.applyMatrix4(j),e.z=P.z,e.renderOrder=b.renderOrder,M.objects.push(e)}this.projectScene=function(b,U,w,C){h=0,p=0,v=0,M.elements.length=0,b.matrixWorldAutoUpdate===!0&&b.updateMatrixWorld(),U.parent===null&&U.matrixWorldAutoUpdate===!0&&U.updateMatrixWorld(),Y.copy(U.matrixWorldInverse),j.multiplyMatrices(U.projectionMatrix,Y),G.setFromProjectionMatrix(j),i=0,M.objects.length=0,M.lights.length=0,X(b),w===!0&&M.objects.sort(_e);const F=M.objects;for(let B=0,T=F.length;B<T;B++){const D=F[B].object,H=D.geometry;if(W.setObject(D),c=D.matrixWorld,n=0,D.isMesh){let ee=D.material;const le=Array.isArray(ee),I=H.attributes,Z=H.groups;if(I.position===void 0)continue;const de=I.position.array;for(let z=0,_=de.length;z<_;z+=3){let N=de[z],Q=de[z+1],q=de[z+2];const me=H.morphAttributes.position;if(me!==void 0){const l=H.morphTargetsRelative,O=D.morphTargetInfluences;for(let $=0,he=me.length;$<he;$++){const ce=O[$];if(ce===0)continue;const ye=me[$];l?(N+=ye.getX(z/3)*ce,Q+=ye.getY(z/3)*ce,q+=ye.getZ(z/3)*ce):(N+=(ye.getX(z/3)-de[z])*ce,Q+=(ye.getY(z/3)-de[z+1])*ce,q+=(ye.getZ(z/3)-de[z+2])*ce)}}W.pushVertex(N,Q,q)}if(I.normal!==void 0){const z=I.normal.array;for(let _=0,N=z.length;_<N;_+=3)W.pushNormal(z[_],z[_+1],z[_+2])}if(I.color!==void 0){const z=I.color.array;for(let _=0,N=z.length;_<N;_+=3)W.pushColor(z[_],z[_+1],z[_+2])}if(I.uv!==void 0){const z=I.uv.array;for(let _=0,N=z.length;_<N;_+=2)W.pushUv(z[_],z[_+1])}if(H.index!==null){const z=H.index.array;if(Z.length>0)for(let _=0;_<Z.length;_++){const N=Z[_];if(ee=le===!0?D.material[N.materialIndex]:D.material,ee!==void 0)for(let Q=N.start,q=N.start+N.count;Q<q;Q+=3)W.pushTriangle(z[Q],z[Q+1],z[Q+2],ee)}else for(let _=0,N=z.length;_<N;_+=3)W.pushTriangle(z[_],z[_+1],z[_+2],ee)}else if(Z.length>0)for(let z=0;z<Z.length;z++){const _=Z[z];if(ee=le===!0?D.material[_.materialIndex]:D.material,ee!==void 0)for(let N=_.start,Q=_.start+_.count;N<Q;N+=3)W.pushTriangle(N,N+1,N+2,ee)}else for(let z=0,_=de.length/3;z<_;z+=3)W.pushTriangle(z,z+1,z+2,ee)}else if(D.isLine){R.multiplyMatrices(j,c);const ee=H.attributes;if(ee.position!==void 0){const le=ee.position.array;for(let I=0,Z=le.length;I<Z;I+=3)W.pushVertex(le[I],le[I+1],le[I+2]);if(ee.color!==void 0){const I=ee.color.array;for(let Z=0,de=I.length;Z<de;Z+=3)W.pushColor(I[Z],I[Z+1],I[Z+2])}if(H.index!==null){const I=H.index.array;for(let Z=0,de=I.length;Z<de;Z+=2)W.pushLine(I[Z],I[Z+1])}else{const I=D.isLineSegments?2:1;for(let Z=0,de=le.length/3-1;Z<de;Z+=I)W.pushLine(Z,Z+1)}}}else if(D.isPoints){R.multiplyMatrices(j,c);const ee=H.attributes;if(ee.position!==void 0){const le=ee.position.array;for(let I=0,Z=le.length;I<Z;I+=3)g.set(le[I],le[I+1],le[I+2],1),g.applyMatrix4(R),se(g,D,U)}}else D.isSprite&&(D.modelViewMatrix.multiplyMatrices(U.matrixWorldInverse,D.matrixWorld),g.set(c.elements[12],c.elements[13],c.elements[14],1),g.applyMatrix4(j),se(g,D,U))}return C===!0&&M.elements.sort(_e),M};function se(b,U,w){const C=1/b.w;b.z*=C,b.z>=-1&&b.z<=1&&(f=ze(),f.id=U.id,f.x=b.x*C,f.y=b.y*C,f.z=b.z,f.renderOrder=U.renderOrder,f.object=U,f.rotation=U.rotation,f.scale.x=U.scale.x*Math.abs(f.x-(b.x+w.projectionMatrix.elements[0])/(b.w+w.projectionMatrix.elements[12])),f.scale.y=U.scale.y*Math.abs(f.y-(b.y+w.projectionMatrix.elements[5])/(b.w+w.projectionMatrix.elements[13])),f.material=U.material,M.elements.push(f))}function be(){if(i===t){const b=new Si;return V.push(b),t++,i++,b}return V[i++]}function Se(){if(n===o){const b=new je;return oe.push(b),o++,n++,b}return oe[n++]}function Le(){if(h===d){const b=new kt;return fe.push(b),d++,h++,b}return fe[h++]}function Me(){if(p===k){const b=new Ft;return ie.push(b),k++,p++,b}return ie[p++]}function ze(){if(v===m){const b=new jt;return K.push(b),m++,v++,b}return K[v++]}function _e(b,U){return b.renderOrder!==U.renderOrder?b.renderOrder-U.renderOrder:b.z!==U.z?U.z-b.z:b.id!==U.id?b.id-U.id:0}function Ae(b,U){let w=0,C=1;const F=b.z+b.w,B=U.z+U.w,T=-b.z+b.w,D=-U.z+U.w;return F>=0&&B>=0&&T>=0&&D>=0?!0:F<0&&B<0||T<0&&D<0?!1:(F<0?w=Math.max(w,F/(F-B)):B<0&&(C=Math.min(C,F/(F-B))),T<0?w=Math.max(w,T/(T-D)):D<0&&(C=Math.min(C,T/(T-D))),C<w?!1:(b.lerp(U,w),U.lerp(b,1-C),!0))}}}class wi{constructor(){let e,i,t,r,n,o,a,h,d,u,p,k=0,f=null,v=1,m,c;const M=this,P=new s.Box2,g=new s.Box2,x=new s.Color,S=new s.Color,A=new s.Color,Y=new s.Color,j=new s.Color,R=new s.Color,G=new s.Vector3,V=new s.Vector3,oe=new s.Vector3,fe=new s.Matrix3,ie=new s.Matrix4,K=new s.Matrix4,pe=[],W=new xi,X=document.createElementNS("http://www.w3.org/2000/svg","svg");this.domElement=X,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.overdraw=.5,this.info={render:{vertices:0,faces:0}},this.setQuality=function(w){switch(w){case"high":v=1;break;case"low":v=0;break}},this.setClearColor=function(w){R.set(w)},this.setPixelRatio=function(){},this.setSize=function(w,C){r=w,n=C,o=r/2,a=n/2,X.setAttribute("viewBox",-o+" "+-a+" "+r+" "+n),X.setAttribute("width",r),X.setAttribute("height",n),P.min.set(-o,-a),P.max.set(o,a)},this.getSize=function(){return{width:r,height:n}},this.setPrecision=function(w){f=w};function re(){for(k=0;X.childNodes.length>0;)X.removeChild(X.childNodes[0])}function se(w){return f!==null?w.toFixed(f):w}this.clear=function(){re(),X.style.backgroundColor=R.getStyle()},this.render=function(w,C){if(!(C instanceof s.Camera)){console.error("THREE.SVGRenderer.render: camera is not an instance of Camera.");return}const F=w.background;F&&F.isColor?(re(),X.style.backgroundColor=F.getStyle()):this.autoClear===!0&&this.clear(),M.info.render.vertices=0,M.info.render.faces=0,ie.copy(C.matrixWorldInverse),K.multiplyMatrices(C.projectionMatrix,ie),e=W.projectScene(w,C,this.sortObjects,this.sortElements),i=e.elements,t=e.lights,fe.getNormalMatrix(C.matrixWorldInverse),be(t),m="",c="";for(let B=0,T=i.length;B<T;B++){const D=i[B],H=D.material;if(!(H===void 0||H.opacity===0)){if(g.makeEmpty(),D instanceof jt)h=D,h.x*=o,h.y*=-a,Le(h,D,H);else if(D instanceof Ft)h=D.v1,d=D.v2,h.positionScreen.x*=o,h.positionScreen.y*=-a,d.positionScreen.x*=o,d.positionScreen.y*=-a,g.setFromPoints([h.positionScreen,d.positionScreen]),P.intersectsBox(g)===!0&&Me(h,d,H);else if(D instanceof kt){if(h=D.v1,d=D.v2,u=D.v3,h.positionScreen.z<-1||h.positionScreen.z>1||d.positionScreen.z<-1||d.positionScreen.z>1||u.positionScreen.z<-1||u.positionScreen.z>1)continue;h.positionScreen.x*=o,h.positionScreen.y*=-a,d.positionScreen.x*=o,d.positionScreen.y*=-a,u.positionScreen.x*=o,u.positionScreen.y*=-a,this.overdraw>0&&(_e(h.positionScreen,d.positionScreen,this.overdraw),_e(d.positionScreen,u.positionScreen,this.overdraw),_e(u.positionScreen,h.positionScreen,this.overdraw)),g.setFromPoints([h.positionScreen,d.positionScreen,u.positionScreen]),P.intersectsBox(g)===!0&&ze(h,d,u,D,H)}}}b(),w.traverseVisible(function(B){if(B.isSVGObject){if(G.setFromMatrixPosition(B.matrixWorld),G.applyMatrix4(K),G.z<-1||G.z>1)return;const T=G.x*o,D=-G.y*a,H=B.node;H.setAttribute("transform","translate("+T+","+D+")"),X.appendChild(H)}})};function be(w){A.setRGB(0,0,0),Y.setRGB(0,0,0),j.setRGB(0,0,0);for(let C=0,F=w.length;C<F;C++){const B=w[C],T=B.color;B.isAmbientLight?(A.r+=T.r,A.g+=T.g,A.b+=T.b):B.isDirectionalLight?(Y.r+=T.r,Y.g+=T.g,Y.b+=T.b):B.isPointLight&&(j.r+=T.r,j.g+=T.g,j.b+=T.b)}}function Se(w,C,F,B){for(let T=0,D=w.length;T<D;T++){const H=w[T],ee=H.color;if(H.isDirectionalLight){const le=G.setFromMatrixPosition(H.matrixWorld).normalize();let I=F.dot(le);if(I<=0)continue;I*=H.intensity,B.r+=ee.r*I,B.g+=ee.g*I,B.b+=ee.b*I}else if(H.isPointLight){const le=G.setFromMatrixPosition(H.matrixWorld);let I=F.dot(G.subVectors(le,C).normalize());if(I<=0||(I*=H.distance==0?1:1-Math.min(C.distanceTo(le)/H.distance,1),I==0))continue;I*=H.intensity,B.r+=ee.r*I,B.g+=ee.g*I,B.b+=ee.b*I}}}function Le(w,C,F){let B=C.scale.x*o,T=C.scale.y*a;F.isPointsMaterial&&(B*=F.size,T*=F.size);const D="M"+se(w.x-B*.5)+","+se(w.y-T*.5)+"h"+se(B)+"v"+se(T)+"h"+se(-B)+"z";let H="";(F.isSpriteMaterial||F.isPointsMaterial)&&(H="fill:"+F.color.getStyle()+";fill-opacity:"+F.opacity),Ae(H,D)}function Me(w,C,F){const B="M"+se(w.positionScreen.x)+","+se(w.positionScreen.y)+"L"+se(C.positionScreen.x)+","+se(C.positionScreen.y);if(F.isLineBasicMaterial){let T="fill:none;stroke:"+F.color.getStyle()+";stroke-opacity:"+F.opacity+";stroke-width:"+F.linewidth+";stroke-linecap:"+F.linecap;F.isLineDashedMaterial&&(T=T+";stroke-dasharray:"+F.dashSize+","+F.gapSize),Ae(T,B)}}function ze(w,C,F,B,T){M.info.render.vertices+=3,M.info.render.faces++;const D="M"+se(w.positionScreen.x)+","+se(w.positionScreen.y)+"L"+se(C.positionScreen.x)+","+se(C.positionScreen.y)+"L"+se(F.positionScreen.x)+","+se(F.positionScreen.y)+"z";let H="";T.isMeshBasicMaterial?(x.copy(T.color),T.vertexColors&&x.multiply(B.color)):T.isMeshLambertMaterial||T.isMeshPhongMaterial||T.isMeshStandardMaterial?(S.copy(T.color),T.vertexColors&&S.multiply(B.color),x.copy(A),V.copy(w.positionWorld).add(C.positionWorld).add(F.positionWorld).divideScalar(3),Se(t,V,B.normalModel,x),x.multiply(S).add(T.emissive)):T.isMeshNormalMaterial&&(oe.copy(B.normalModel).applyMatrix3(fe).normalize(),x.setRGB(oe.x,oe.y,oe.z).multiplyScalar(.5).addScalar(.5)),T.wireframe?H="fill:none;stroke:"+x.getStyle()+";stroke-opacity:"+T.opacity+";stroke-width:"+T.wireframeLinewidth+";stroke-linecap:"+T.wireframeLinecap+";stroke-linejoin:"+T.wireframeLinejoin:H="fill:"+x.getStyle()+";fill-opacity:"+T.opacity,Ae(H,D)}function _e(w,C,F){let B=C.x-w.x,T=C.y-w.y;const D=B*B+T*T;if(D===0)return;const H=F/Math.sqrt(D);B*=H,T*=H,C.x+=B,C.y+=T,w.x-=B,w.y-=T}function Ae(w,C){c===w?m+=C:(b(),c=w,m=C)}function b(){m&&(p=U(k++),p.setAttribute("d",m),p.setAttribute("style",c),X.appendChild(p)),m="",c=""}function U(w){return pe[w]==null&&(pe[w]=document.createElementNS("http://www.w3.org/2000/svg","path"),v==0&&pe[w].setAttribute("shape-rendering","crispEdges")),pe[w]}}}class Mi{constructor(e){this.css2dRender=null,this.css3dRender=null,this.svgRender=null,this._resizeObserver=null,this._ssThreeObject=null,this.destory=()=>{this._removeResizeOBserver(),E.SSThreeLoop.removeIds(["svgFrameHandle","css2dFrameHandle","css3dFrameHandle"]),this.cancelRender2D(),this.cancelRender3D(),this.cancelRenderSVG(),this._ssThreeObject=null},this.render2D=()=>{const{threeScene:i,threeCamera:t,threeContainer:r}=this._ssThreeObject;this._addResizeObserver(r),!this.css2dRender&&(this.css2dRender=new mi,this.css2dRender.domElement.style.position="absolute",this.css2dRender.domElement.style.top="0px",this.css2dRender.setSize(r.offsetWidth,r.offsetHeight),r.appendChild(this.css2dRender.domElement),E.SSThreeLoop.add(()=>{this.css2dRender.render(i,t)},"css2dFrameHandle"))},this.cancelRender2D=()=>{var i,t;E.SSThreeLoop.removeId("css2dFrameHandle"),(t=(i=this.css2dRender)==null?void 0:i.domElement)==null||t.remove(),this.css2dRender=null},this.render3D=()=>{const{threeScene:i,threeCamera:t,threeContainer:r}=this._ssThreeObject;this._addResizeObserver(r),!this.css3dRender&&(this.css3dRender=new bi,this.css3dRender.domElement.style.position="absolute",this.css3dRender.domElement.style.top="0px",this.css3dRender.setSize(r.offsetWidth,r.offsetHeight),r.appendChild(this.css3dRender.domElement),E.SSThreeLoop.add(()=>{this.css3dRender.render(i,t)},"css3dFrameHandle"))},this.cancelRender3D=()=>{var i,t;E.SSThreeLoop.removeId("css3dFrameHandle"),(t=(i=this.css3dRender)==null?void 0:i.domElement)==null||t.remove(),this.css3dRender=null},this.renderSVG=()=>{const{threeScene:i,threeCamera:t,threeContainer:r}=this._ssThreeObject;this._addResizeObserver(r),!this.svgRender&&(this.svgRender=new wi,this.svgRender.domElement.style.position="absolute",this.svgRender.domElement.style.top="0px",this.svgRender.setSize(r.offsetWidth,r.offsetHeight),r.appendChild(this.svgRender.domElement),E.SSThreeLoop.add(()=>{this.svgRender.render(i,t)},"svgFrameHandle"))},this.cancelRenderSVG=()=>{var i,t;E.SSThreeLoop.removeId("svgFrameHandle"),(t=(i=this.svgRender)==null?void 0:i.domElement)==null||t.remove(),this.svgRender=null},this.drawingLabel=(i,t,r,n)=>{const o=[i,t,r],a=new L.LineBasicMaterial({color:51390,linewidth:10}),h=new L.BufferGeometry().setFromPoints(o),d=new L.Line(h,a),u=document.createElement("div");u.className="label",u.style.fontSize="40px",u.style.marginTop="-42px",u.style.padding="40px 80px",u.style.backgroundColor="#fff",u.style.color="#000000",u.style.border="1px solid #16BFB0",u.textContent=n||"示例";const p=new zt(u);return p.position.set(r.x,r.y,r.z),{line:d,tagLabel:p}},this.drawLines=(i,t,r=.001)=>{i.length()===0&&(i.x=.001);const n=0,o=n*2.5,a=n*n*50,h=new L.Vector3(0,0,0),d=new L.Ray(h,this._getVCenter(i.clone(),t.clone())),u=d.at(a/d.at(1,new L.Vector3).distanceTo(h),new L.Vector3),p=this._getLenVcetor(i.clone(),u,o),k=this._getLenVcetor(t.clone(),u,o),f=new L.CubicBezierCurve3(i,p,k,t),v=new E.LineGeometry,m=f.getPoints(50),c=[],M=[],P=new L.Color;for(let x=0;x<m.length;x++)P.setHSL(.31666+x*.005,.7,.7),M.push(P.r,P.g,P.b),c.push(m[x].x,m[x].y,m[x].z);v.setPositions(c),v.setColors(M);const g=new E.LineMaterial({linewidth:r,vertexColors:!0,dashed:!1});return{curve:f,lineMesh:new E.Line2(v,g)}},this._getVCenter=(i,t)=>i.add(t).divideScalar(2),this._getLenVcetor=(i,t,r)=>{const n=i.distanceTo(t);return i.lerp(t,r/n)},this._addResizeObserver=(i=document.body)=>{if(this._resizeObserver===null){const t=new window.ResizeObserver(()=>{this.css2dRender&&(E.SSThreeLoop.removeId("css2dFrameHandle"),this.css2dRender.setSize(i.offsetWidth,i.offsetHeight),E.SSThreeLoop.add(()=>{this.css2dRender.render(this._ssThreeObject.threeScene,this._ssThreeObject.threeCamera)},"css2dFrameHandle")),this.css3dRender&&(E.SSThreeLoop.removeId("css3dFrameHandle"),this.css3dRender.setSize(i.offsetWidth,i.offsetHeight),E.SSThreeLoop.add(()=>{this.css3dRender.render(this._ssThreeObject.threeScene,this._ssThreeObject.threeCamera)},"css3dFrameHandle")),this.svgRender&&(E.SSThreeLoop.removeId("svgFrameHandle"),this.svgRender.setSize(i.offsetWidth,i.offsetHeight),E.SSThreeLoop.add(()=>{this.svgRender.render(this._ssThreeObject.threeScene,this._ssThreeObject.threeCamera)},"svgFrameHandle"))});t.observe(i),this._resizeObserver=t}},this._removeResizeOBserver=()=>{this._resizeObserver!==null&&(this._resizeObserver.disconnect(),this._resizeObserver=null)},this._ssThreeObject=e}}class _i{static pathFromPoints(e,i,t){const r=this.pathGeomery(e,t);return new L.Mesh(r,i)}static pathTubefromPoints(e,i,t){const r=this.pathGeomery(e,t);return new L.Mesh(r,i)}static pathGeomery(e,i){const t=new E.PathPointList;t.set(e,i.cornerRadius,i.cornerSplit,i.up,i.close);const r=new E.PathGeometry({pathPointList:t,options:{width:.1,arrow:!0,progress:1,side:"both"},usage:L.StaticDrawUsage});return r.update(t,{width:.1,arrow:!0,progress:1,side:"both"}),r}static pathTubeGeometry(e,i){const t=new E.PathPointList;t.set(e,i.cornerRadius,i.cornerSplit,i.up,i.close);const r=new E.PathTubeGeometry({pathPointList:t,options:{radius:.1,radialSegments:8,progress:1,startRad:0},usage:L.StaticDrawUsage},!1);return r.update(t,{radius:.1,radialSegments:8,progress:1,startRad:0}),r}}const Ti={WallMesh:E.SSWallMesh,WaterMesh:E.SSWaterMesh,PathMesh:_i};exports.THREE=L;exports.SSDispose=E.SSDispose;exports.SSLoader=E.SSLoader;exports.SSThreeEvent=E.SSEvent;exports.SSThreeLoop=E.SSThreeLoop;exports.SSThreeTool=E.SSThreeTool;exports.CSS2DObject=zt;exports.CSS3DObject=yi;exports.SSCssRenderer=Mi;exports.SSFileSetting=At;exports.SSMaterial=pi;exports.SSMesh=Ti;exports.SSThreeObject=Lt;exports.default=fi;
